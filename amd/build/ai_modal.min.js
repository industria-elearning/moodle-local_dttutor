/**
 * AI Mode - Fullscreen modal chat functionality
 *
 * @module     local_dttutor/ai_modal
 * @copyright  2025 Industria Elearning
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_dttutor/ai_modal",["jquery","core/ajax","core/notification"],(function($,Ajax,Notification){const SELECTORS_MODAL_TRIGGER='[data-action="open-ai-modal"]',SELECTORS_MODAL='[data-region="ai-modal"]',SELECTORS_CLOSE_BTN='[data-action="close-ai-modal"]',SELECTORS_INPUT='[data-region="ai-modal-input"]',SELECTORS_SEND_BTN='[data-action="send-ai-message"]',SELECTORS_MESSAGES_CONTAINER='[data-region="ai-modal-messages"]',SELECTORS_MESSAGES_SCROLL=".ai-modal-messages-scroll",SELECTORS_QUICK_OPTIONS='[data-action="quick-option"]',SELECTORS_QUICK_OPTIONS_CONTAINER='[data-region="quick-options"]',SELECTORS_WELCOME=".ai-modal-welcome";class AIModal{constructor(){this.modal=null,this.streaming=!1,this.currentEventSource=null,this.currentSessionId=null,this.conversationStarted=!1,this.courseId=null,this.cmId=null,this.userId=null,this.init()}init(){this.registerEventListeners()}registerEventListeners(){$(document).on("click",SELECTORS_MODAL_TRIGGER,(e=>{e.preventDefault(),this.openModal()})),$(document).on("click",SELECTORS_CLOSE_BTN,(e=>{e.preventDefault(),this.closeModal()})),$(document).on("click",SELECTORS_SEND_BTN,(()=>{this.sendMessage()})),$(document).on("keydown",SELECTORS_INPUT,(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())})),$(document).on("input",SELECTORS_INPUT,(function(){this.style.height="auto",this.style.height=Math.min(this.scrollHeight,120)+"px"})),$(document).on("click",SELECTORS_QUICK_OPTIONS,(e=>{e.preventDefault();const prompt=$(e.currentTarget).data("prompt");this.handleQuickOption(prompt)})),$(document).on("click",SELECTORS_MODAL,(e=>{$(e.target).is(SELECTORS_MODAL)&&e.stopPropagation()})),$(document).on("keydown",(e=>{"Escape"===e.key&&this.isModalOpen()&&(e.preventDefault(),e.stopPropagation())})),$(window).on("beforeunload",(()=>this.cleanup()))}isModalOpen(){return this.modal&&this.modal.is(":visible")}openModal(){this.modal||(this.modal=$(SELECTORS_MODAL)),this.modal.length?(this.courseId=this.modal.data("courseid"),this.cmId=this.modal.data("cmid")||0,this.userId=this.modal.data("userid"),this.modal.fadeIn(300),$("body").addClass("ai-modal-open"),setTimeout((()=>{this.modal.find(SELECTORS_INPUT).focus()}),350)):window.console.error("AI Modal not found in DOM")}closeModal(){this.modal&&(this.closeCurrentStream(),this.modal.fadeOut(300),$("body").removeClass("ai-modal-open"),this.conversationStarted=!1,this.currentSessionId=null,this.modal.find(SELECTORS_MESSAGES_SCROLL).empty(),this.modal.find(SELECTORS_MESSAGES_CONTAINER).hide(),this.modal.find(SELECTORS_WELCOME).show(),this.modal.find(SELECTORS_QUICK_OPTIONS_CONTAINER).show(),this.modal.find(SELECTORS_INPUT).val("").css("height","auto"))}handleQuickOption(prompt){if(!prompt||this.streaming)return;this.modal.find(SELECTORS_INPUT).val(prompt).focus();const input=this.modal.find(SELECTORS_INPUT)[0];input.style.height="auto",input.style.height=Math.min(input.scrollHeight,120)+"px"}sendMessage(){const input=this.modal.find(SELECTORS_INPUT),sendBtn=this.modal.find(SELECTORS_SEND_BTN),messageText=input.val().trim();if(messageText&&!this.streaming)if(messageText.length>4e3)this.addMessage("[Error] Message is too long. Maximum 4000 characters.","ai");else try{this.closeCurrentStream(),sendBtn.prop("disabled",!0),this.conversationStarted||this.startConversation(),this.addMessage(messageText,"user"),input.val(""),input.css("height","auto"),this.scrollToBottom(),this.showTypingIndicator();const metaData={user_role:"User",timestamp:Math.floor(Date.now()/1e3),source:"ai_modal"};this.cmId&&this.cmId>0&&(metaData.cmid=parseInt(this.cmId,10));const pageContext=this.detectPageContext();pageContext.pagetype&&(metaData.page=pageContext.pagetype),window.console.log("AI Modal sending metadata:",metaData);Ajax.call([{methodname:"local_dttutor_create_chat_message",args:{courseid:parseInt(this.courseId,10),message:this.sanitizeString(messageText.substring(0,4e3)),meta:JSON.stringify(metaData)}}])[0].then((data=>{if(!data||!data.stream_url)throw new Error("Stream URL missing in response");return this.currentSessionId=data.session_id,this.startSSE(data.stream_url,sendBtn),data})).catch((err=>{this.hideTypingIndicator(),this.addMessage("[Error] "+(err.message||"Unknown error"),"ai"),sendBtn.prop("disabled",!1),Notification.exception(err)}))}catch(error){this.hideTypingIndicator(),this.addMessage("[Error] Internal error: "+error.message,"ai"),sendBtn.prop("disabled",!1)}}startConversation(){this.modal.find(SELECTORS_WELCOME).hide(),this.modal.find(SELECTORS_QUICK_OPTIONS_CONTAINER).hide(),this.modal.find(SELECTORS_MESSAGES_CONTAINER).show(),this.conversationStarted=!0}startSSE(streamUrl,sendBtn){try{const es=new EventSource(streamUrl);this.currentEventSource=es,this.streaming=!0;let firstToken=!0,messageCompleted=!1,currentMessageEl=null;es.addEventListener("token",(ev=>{try{const payload=JSON.parse(ev.data),text=payload.t||payload.content||"";firstToken&&(firstToken=!1,currentMessageEl=this.createAIMessage(),this.hideTypingIndicator()),this.appendToMessage(currentMessageEl,text)}catch(e){window.console.warn("Invalid token data:",ev.data)}})),es.addEventListener("done",(()=>{messageCompleted=!0,this.finalizeStream(sendBtn)})),es.addEventListener("message_completed",(()=>{messageCompleted=!0,this.finalizeStream(sendBtn)})),es.addEventListener("error",(()=>{messageCompleted||(window.console.error("SSE error"),currentMessageEl&&this.appendToMessage(currentMessageEl,"\n[Connection interrupted]"),this.finalizeStream(sendBtn))}))}catch(error){window.console.error("Error starting SSE:",error),this.addMessage("[Error] Could not establish SSE connection","ai"),this.finalizeStream(sendBtn)}}createAIMessage(){const messagesScroll=this.modal.find(SELECTORS_MESSAGES_SCROLL),messageEl=$('<div class="tutor-ia-message ai"></div>');return messagesScroll.append(messageEl),this.scrollToBottom(),messageEl[0]}appendToMessage(messageEl,text){if(!messageEl||"string"!=typeof text)return;const currentText=messageEl.textContent||"";if(currentText.length+text.length>1e4){const remaining=1e4-currentText.length;remaining>0&&(messageEl.textContent+=text.substring(0,remaining)+"...")}else messageEl.textContent+=text,this.scrollToBottom()}addMessage(text,type){if(!text||"string"!=typeof text)return;const messagesScroll=this.modal.find(SELECTORS_MESSAGES_SCROLL),messageEl=$("<div></div>").addClass("tutor-ia-message").addClass(type).text(text.substring(0,1e4));messagesScroll.append(messageEl),this.scrollToBottom()}showTypingIndicator(){const messagesScroll=this.modal.find(SELECTORS_MESSAGES_SCROLL);if(messagesScroll.find(".tutor-ia-typing").length)return;const typing=$('<div class="tutor-ia-message ai tutor-ia-typing"></div>').html('<span class="dot"></span><span class="dot"></span><span class="dot"></span>');messagesScroll.append(typing),this.scrollToBottom()}hideTypingIndicator(){this.modal.find(".tutor-ia-typing").remove()}scrollToBottom(){const messagesScroll=this.modal.find(SELECTORS_MESSAGES_SCROLL);messagesScroll.length&&messagesScroll.scrollTop(messagesScroll[0].scrollHeight)}closeCurrentStream(){if(this.currentEventSource)try{this.currentEventSource.close()}catch(e){window.console.warn("Error closing EventSource:",e)}this.currentEventSource=null,this.streaming=!1,this.hideTypingIndicator()}finalizeStream(sendBtn){this.closeCurrentStream(),sendBtn&&sendBtn.prop("disabled",!1)}sanitizeString(str){return"string"!=typeof str?"":str.replace(/[<>]/g,"")}detectPageContext(){const context={};if("undefined"!=typeof M&&M.cfg&&M.cfg.pagetype&&(context.pagetype=M.cfg.pagetype),!context.pagetype){const bodyId=document.body.id;bodyId&&(context.pagetype=bodyId.replace("page-",""))}return context}cleanup(){this.closeCurrentStream()}}return{init:function(){return new AIModal}}}));

//# sourceMappingURL=ai_modal.min.js.map