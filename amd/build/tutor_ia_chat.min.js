/**
 * Tutor-IA Chat - Drawer and chat functionality (based on aiplacement_courseassist)
 *
 * @module     local_dttutor/tutor_ia_chat
 * @copyright  2025 Datacurso
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_dttutor/tutor_ia_chat",["jquery","core/ajax","core/notification","core/pubsub"],(function($,Ajax,Notification,PubSub){const SELECTORS_TOGGLE_BTN='[data-action="tutor-ia-toggle"]',SELECTORS_DRAWER=".tutor-ia-drawer",SELECTORS_CLOSE_BTN=".tutor-ia-close-button",SELECTORS_MESSAGES='[data-region="tutor-ia-messages"]',SELECTORS_INPUT='[data-region="tutor-ia-input"]',SELECTORS_SEND_BTN='[data-action="send-message"]',SELECTORS_PAGE="#page",SELECTORS_JUMP_TO="#jump-to",SELECTORS_BODY="body";class TutorIAChat{constructor(root,uniqueId,courseId,cmId,userId){this.root=$(root),this.uniqueId=uniqueId,this.courseId=courseId,this.cmId=cmId,this.userId=userId,this.streaming=!1,this.currentEventSource=null,this.currentSessionId=null,this.currentAIMessageEl=null,this.drawerElement=document.querySelector(SELECTORS_DRAWER),this.pageElement=document.querySelector(SELECTORS_PAGE),this.bodyElement=document.querySelector(SELECTORS_BODY),this.toggleButton=document.querySelector(SELECTORS_TOGGLE_BTN),this.closeButton=document.querySelector(SELECTORS_CLOSE_BTN),this.jumpTo=document.querySelector(SELECTORS_JUMP_TO),this.position=this.drawerElement&&this.drawerElement.getAttribute("data-position")||"right",this.pageClass="left"===this.position?"show-drawer-left":"show-drawer-right",this.bodyClass="left"===this.position?"tutor-ia-drawer-open-left":"tutor-ia-drawer-open-right",this.pageContext=this.detectPageContext(),this.init()}detectPageContext(){const context={};if("undefined"!=typeof M&&M.cfg&&M.cfg.pagetype&&(context.pagetype=M.cfg.pagetype),!context.pagetype){const bodyId=document.body.id;bodyId&&(context.pagetype=bodyId.replace("page-",""))}if(!context.pagetype){const pathMatch=document.body.className.match(/path-([\w-]+)/);pathMatch&&(context.pagetype=pathMatch[1])}const urlParams=new URLSearchParams(window.location.search);return context.pagetype&&context.pagetype.includes("forum")?(urlParams.has("d")&&(context.discussionid=parseInt(urlParams.get("d"),10)),urlParams.has("f")&&(context.forumid=parseInt(urlParams.get("f"),10))):context.pagetype&&context.pagetype.includes("quiz")?urlParams.has("attempt")&&(context.attemptid=parseInt(urlParams.get("attempt"),10)):context.pagetype&&context.pagetype.includes("assign")?urlParams.has("id")&&(context.assignid=parseInt(urlParams.get("id"),10)):context.pagetype&&context.pagetype.includes("wiki")&&urlParams.has("pageid")&&(context.pageid=parseInt(urlParams.get("pageid"),10)),window.console.log("Tutor-IA Page Context:",context),window.console.log("Body ID:",document.body.id),window.console.log("Body Classes:",document.body.className),window.console.log("URL Params:",window.location.search),context}init(){this.registerEventListeners(),window.addEventListener("beforeunload",(()=>this.cleanup()))}registerEventListeners(){this.toggleButton&&this.toggleButton.addEventListener("click",(e=>{e.preventDefault(),this.toggleDrawer()})),this.closeButton&&this.closeButton.addEventListener("click",(e=>{e.preventDefault(),this.closeDrawer()})),this.root.find(SELECTORS_SEND_BTN).on("click",(()=>{this.sendMessage()}));const input=this.root.find(SELECTORS_INPUT);input.on("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())})),input.on("input",(function(){this.style.height="auto",this.style.height=Math.min(this.scrollHeight,120)+"px"})),document.addEventListener("keydown",(e=>{this.isDrawerOpen()&&"Escape"===e.key&&this.closeDrawer()})),PubSub.subscribe("core_message/drawer_shown",(()=>{this.isDrawerOpen()&&this.closeDrawer()})),this.jumpTo&&this.jumpTo.addEventListener("focus",(()=>{this.closeButton&&this.closeButton.focus()}))}isDrawerOpen(){return this.drawerElement&&this.drawerElement.classList.contains("show")}openDrawer(){this.drawerElement&&(PubSub.publish("core_message/hide",{}),this.drawerElement.classList.add("show"),this.drawerElement.setAttribute("tabindex","0"),this.pageElement&&!this.pageElement.classList.contains(this.pageClass)&&this.pageElement.classList.add(this.pageClass),this.bodyElement&&!this.bodyElement.classList.contains(this.bodyClass)&&this.bodyElement.classList.add(this.bodyClass),this.jumpTo&&(this.jumpTo.setAttribute("tabindex",0),this.jumpTo.focus()))}closeDrawer(){this.drawerElement&&(this.drawerElement.classList.remove("show"),this.drawerElement.setAttribute("tabindex","-1"),this.pageElement&&this.pageElement.classList.contains(this.pageClass)&&this.pageElement.classList.remove(this.pageClass),this.bodyElement&&this.bodyElement.classList.contains(this.bodyClass)&&this.bodyElement.classList.remove(this.bodyClass),this.jumpTo&&this.jumpTo.setAttribute("tabindex",-1),this.toggleButton&&this.toggleButton.focus())}toggleDrawer(){this.isDrawerOpen()?this.closeDrawer():this.openDrawer()}sendMessage(){const input=this.root.find(SELECTORS_INPUT),sendBtn=this.root.find(SELECTORS_SEND_BTN),messageText=input.val().trim();if(messageText&&!this.streaming)if(messageText.length>4e3)this.addMessage("[Error] Message is too long. Maximum 4000 characters.","ai");else try{this.closeCurrentStream(),sendBtn.prop("disabled",!0),this.addMessage(messageText,"user"),input.val(""),input.css("height","auto"),this.scrollToBottom(),this.showTypingIndicator();const metaData={user_role:"Student",timestamp:Math.floor(Date.now()/1e3)};this.pageContext.pagetype&&(metaData.page=this.pageContext.pagetype),this.pageContext.discussionid&&(metaData.discussionid=this.pageContext.discussionid),this.pageContext.forumid&&(metaData.forumid=this.pageContext.forumid),this.pageContext.attemptid&&(metaData.attemptid=this.pageContext.attemptid),this.pageContext.assignid&&(metaData.assignid=this.pageContext.assignid),this.pageContext.pageid&&(metaData.pageid=this.pageContext.pageid),this.cmId&&(metaData.cmid=parseInt(this.cmId,10)),window.console.log("Tutor-IA sending metadata:",metaData);Ajax.call([{methodname:"local_dttutor_create_chat_message",args:{courseid:parseInt(this.courseId,10),message:this.sanitizeString(messageText.substring(0,4e3)),meta:JSON.stringify(metaData)}}])[0].then((data=>{if(!data||!data.stream_url)throw new Error("Stream URL missing in response");return this.currentSessionId=data.session_id,this.startSSE(data.stream_url,sendBtn),data})).catch((err=>{this.hideTypingIndicator(),this.addMessage("[Error] "+(err.message||"Unknown error"),"ai"),sendBtn.prop("disabled",!1),Notification.exception(err)}))}catch(error){this.hideTypingIndicator(),this.addMessage("[Error] Internal error: "+error.message,"ai"),sendBtn.prop("disabled",!1)}}startSSE(streamUrl,sendBtn){try{const es=new EventSource(streamUrl);this.currentEventSource=es,this.streaming=!0;let firstToken=!0,messageCompleted=!1;es.addEventListener("token",(ev=>{try{const payload=JSON.parse(ev.data),text=payload.t||payload.content||"";firstToken&&(firstToken=!1,this.ensureAIMessageEl(),this.hideTypingIndicator()),this.appendToAIMessage(text)}catch(e){window.console.warn("Invalid token data:",ev.data)}})),es.addEventListener("done",(()=>{messageCompleted=!0,this.finalizeStream(sendBtn)})),es.addEventListener("message_completed",(()=>{messageCompleted=!0,this.finalizeStream(sendBtn)})),es.addEventListener("error",(e=>{messageCompleted||(window.console.error("SSE error:",e),this.appendToAIMessage("\n[Connection interrupted]"),this.finalizeStream(sendBtn))}))}catch(error){window.console.error("Error starting SSE:",error),this.addMessage("[Error] Could not establish SSE connection","ai"),this.finalizeStream(sendBtn)}}ensureAIMessageEl(){if(this.currentAIMessageEl)return this.currentAIMessageEl;const messages=this.root.find(SELECTORS_MESSAGES);let el=messages.find(".tutor-ia-typing");return el.length?(el.removeClass("tutor-ia-typing"),el.addClass("tutor-ia-message ai"),el.html("")):(el=$('<div class="tutor-ia-message ai"></div>'),messages.append(el)),this.currentAIMessageEl=el[0],this.currentAIMessageEl}appendToAIMessage(text){if(this.currentAIMessageEl||this.ensureAIMessageEl(),!this.currentAIMessageEl||"string"!=typeof text)return;const currentText=this.currentAIMessageEl.textContent||"";if(currentText.length+text.length>1e4){const remaining=1e4-currentText.length;remaining>0&&(this.currentAIMessageEl.textContent+=text.substring(0,remaining)+"...")}else this.currentAIMessageEl.textContent+=text,this.scrollToBottom()}addMessage(text,type){if(!text||"string"!=typeof text)return;const messages=this.root.find(SELECTORS_MESSAGES),messageEl=$("<div></div>").addClass("tutor-ia-message").addClass(type).text(text.substring(0,1e4));messages.append(messageEl),this.scrollToBottom()}showTypingIndicator(){const messages=this.root.find(SELECTORS_MESSAGES);if(messages.find(".tutor-ia-typing").length)return;const typing=$('<div class="tutor-ia-message ai tutor-ia-typing"></div>').html('<span class="dot"></span><span class="dot"></span><span class="dot"></span>');messages.append(typing),this.scrollToBottom()}hideTypingIndicator(){this.root.find(".tutor-ia-typing").remove()}scrollToBottom(){const messages=this.root.find(SELECTORS_MESSAGES);messages.scrollTop(messages[0].scrollHeight)}closeCurrentStream(){if(this.currentEventSource)try{this.currentEventSource.close()}catch(e){window.console.warn("Error closing EventSource:",e)}this.currentEventSource=null,this.streaming=!1,this.currentAIMessageEl=null,this.hideTypingIndicator()}finalizeStream(sendBtn){this.closeCurrentStream(),sendBtn&&sendBtn.prop("disabled",!1)}sanitizeString(str){return"string"!=typeof str?"":str.replace(/[<>]/g,"")}cleanup(){this.closeCurrentStream()}destroy(){this.cleanup()}}return{init:function(root,uniqueId,courseId,cmId,userId){return new TutorIAChat(root,uniqueId,courseId,cmId,userId)}}}));

//# sourceMappingURL=tutor_ia_chat.min.js.map