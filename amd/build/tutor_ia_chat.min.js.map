{"version":3,"file":"tutor_ia_chat.min.js","sources":["../src/tutor_ia_chat.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tutor-IA Chat - Drawer and chat functionality (based on aiplacement_courseassist)\n *\n * @module     local_dttutor/tutor_ia_chat\n * @copyright  2025 Datacurso\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'core/pubsub'\n], function(\n    $,\n    Ajax,\n    Notification,\n    PubSub\n) {\n    'use strict';\n\n    const SELECTORS = {\n        TOGGLE_BTN: '[data-action=\"tutor-ia-toggle\"]',\n        DRAWER: '.tutor-ia-drawer',\n        CLOSE_BTN: '.tutor-ia-close-button',\n        MESSAGES: '[data-region=\"tutor-ia-messages\"]',\n        INPUT: '[data-region=\"tutor-ia-input\"]',\n        SEND_BTN: '[data-action=\"send-message\"]',\n        PAGE: '#page',\n        JUMP_TO: '#jump-to',\n        BODY: 'body'\n    };\n\n    class TutorIAChat {\n        constructor(root, uniqueId, courseId, cmId, userId) {\n            this.root = $(root);\n            this.uniqueId = uniqueId;\n            this.courseId = courseId;\n            this.cmId = cmId;\n            this.userId = userId;\n            this.streaming = false;\n            this.currentEventSource = null;\n            this.currentSessionId = null;\n            this.currentAIMessageEl = null;\n\n            // History pagination state\n            this.historyOffset = 0;\n            this.historyLimit = 20;\n            this.isLoadingHistory = false;\n            this.hasMoreHistory = true;\n            this.historyLoaded = false;\n\n            this.drawerElement = document.querySelector(SELECTORS.DRAWER);\n            this.pageElement = document.querySelector(SELECTORS.PAGE);\n            this.bodyElement = document.querySelector(SELECTORS.BODY);\n            this.toggleButton = document.querySelector(SELECTORS.TOGGLE_BTN);\n            this.closeButton = document.querySelector(SELECTORS.CLOSE_BTN);\n            this.jumpTo = document.querySelector(SELECTORS.JUMP_TO);\n\n            // Detect drawer position (right/left) from data-position.\n            this.position = this.drawerElement ? this.drawerElement.getAttribute('data-position') || 'right' : 'right';\n            this.pageClass = this.position === 'left' ? 'show-drawer-left' : 'show-drawer-right';\n            // Class to identify that Tutor-IA drawer is open (to move footer-popover).\n            this.bodyClass = this.position === 'left' ? 'tutor-ia-drawer-open-left' : 'tutor-ia-drawer-open-right';\n\n            // Capture contextual information from the page.\n            this.pageContext = this.detectPageContext();\n\n            this.init();\n        }\n\n        /**\n         * Detects the current page context (page type and relevant parameters).\n         *\n         * @returns {Object} Object with page contextual information\n         */\n        detectPageContext() {\n            const context = {};\n\n            // Method 1: Try to get pagetype from M.cfg.\n            if (typeof M !== 'undefined' && M.cfg && M.cfg.pagetype) {\n                context.pagetype = M.cfg.pagetype;\n            }\n\n            // Method 2: If not available, use body id/class (more reliable).\n            if (!context.pagetype) {\n                const bodyId = document.body.id;\n                if (bodyId) {\n                    // Body id format: \"page-mod-forum-discuss\" or \"page-course-view-topics\".\n                    // Extract the part after \"page-\".\n                    context.pagetype = bodyId.replace('page-', '');\n                }\n            }\n\n            // Method 3: Fallback using body classes.\n            if (!context.pagetype) {\n                const bodyClasses = document.body.className;\n                // Look for classes with format \"path-mod-forum\", \"pagelayout-incourse\", etc.\n                const pathMatch = bodyClasses.match(/path-([\\w-]+)/);\n                if (pathMatch) {\n                    context.pagetype = pathMatch[1];\n                }\n            }\n\n            // Get URL parameters.\n            const urlParams = new URLSearchParams(window.location.search);\n\n            // Extract common parameters based on page type.\n            if (context.pagetype && context.pagetype.includes('forum')) {\n                // Forum discussion ID.\n                if (urlParams.has('d')) {\n                    context.discussionid = parseInt(urlParams.get('d'), 10);\n                }\n                // Forum ID.\n                if (urlParams.has('f')) {\n                    context.forumid = parseInt(urlParams.get('f'), 10);\n                }\n            } else if (context.pagetype && context.pagetype.includes('quiz')) {\n                // Quiz attempt ID.\n                if (urlParams.has('attempt')) {\n                    context.attemptid = parseInt(urlParams.get('attempt'), 10);\n                }\n            } else if (context.pagetype && context.pagetype.includes('assign')) {\n                // Assignment ID.\n                if (urlParams.has('id')) {\n                    context.assignid = parseInt(urlParams.get('id'), 10);\n                }\n            } else if (context.pagetype && context.pagetype.includes('wiki')) {\n                // Wiki page ID.\n                if (urlParams.has('pageid')) {\n                    context.pageid = parseInt(urlParams.get('pageid'), 10);\n                }\n            }\n\n            return context;\n        }\n\n        init() {\n            this.registerEventListeners();\n            window.addEventListener('beforeunload', () => this.cleanup());\n        }\n\n        registerEventListeners() {\n            // Toggle button.\n            if (this.toggleButton) {\n                this.toggleButton.addEventListener('click', (e) => {\n                    e.preventDefault();\n                    this.toggleDrawer();\n                });\n            }\n\n            // Close button.\n            if (this.closeButton) {\n                this.closeButton.addEventListener('click', (e) => {\n                    e.preventDefault();\n                    this.closeDrawer();\n                });\n            }\n\n            // Send button.\n            this.root.find(SELECTORS.SEND_BTN).on('click', () => {\n                this.sendMessage();\n            });\n\n            // Input - Enter to send.\n            const input = this.root.find(SELECTORS.INPUT);\n            input.on('keydown', (e) => {\n                if (e.key === 'Enter' && !e.shiftKey) {\n                    e.preventDefault();\n                    this.sendMessage();\n                }\n            });\n\n            // Auto-resize textarea.\n            input.on('input', function() {\n                this.style.height = 'auto';\n                this.style.height = Math.min(this.scrollHeight, 120) + 'px';\n            });\n\n            // Infinity scroll for history\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n            messagesContainer.on('scroll', () => {\n                this.handleHistoryScroll();\n            });\n\n            // Close on Escape key.\n            document.addEventListener('keydown', (e) => {\n                if (this.isDrawerOpen() && e.key === 'Escape') {\n                    this.closeDrawer();\n                }\n            });\n\n            // Close drawer if message drawer opens.\n            PubSub.subscribe('core_message/drawer_shown', () => {\n                if (this.isDrawerOpen()) {\n                    this.closeDrawer();\n                }\n            });\n\n            // Jump to functionality.\n            if (this.jumpTo) {\n                this.jumpTo.addEventListener('focus', () => {\n                    if (this.closeButton) {\n                        this.closeButton.focus();\n                    }\n                });\n            }\n        }\n\n        isDrawerOpen() {\n            return this.drawerElement && this.drawerElement.classList.contains('show');\n        }\n\n        openDrawer() {\n            console.log(\"Open drawer called\");\n            if (!this.drawerElement) {\n                console.log(\"Could not open drawer\");\n                return;\n            }\n\n            // Close message drawer if open.\n            PubSub.publish('core_message/hide', {});\n\n            this.drawerElement.classList.add('show');\n            this.drawerElement.setAttribute('tabindex', '0');\n\n            // Update toggle button aria-expanded.\n            if (this.toggleButton) {\n                this.toggleButton.setAttribute('aria-expanded', 'true');\n            }\n\n            // Add padding to page (redistribute space) - uses this.pageClass (show-drawer-left or show-drawer-right).\n            if (this.pageElement && !this.pageElement.classList.contains(this.pageClass)) {\n                this.pageElement.classList.add(this.pageClass);\n            }\n\n            // Add class to body to identify Tutor-IA drawer is open (for footer-popover positioning).\n            if (this.bodyElement && !this.bodyElement.classList.contains(this.bodyClass)) {\n                this.bodyElement.classList.add(this.bodyClass);\n            }\n\n            // Focus management.\n            if (this.jumpTo) {\n                this.jumpTo.setAttribute('tabindex', 0);\n                this.jumpTo.focus();\n            }\n\n            // Load chat history on first open\n            //if (!this.historyLoaded && this.currentSessionId) {\n                this.loadChatHistory();\n            console.log(\"First open\");\n            //}\n        }\n\n        closeDrawer() {\n            if (!this.drawerElement) {\n                return;\n            }\n\n            this.drawerElement.classList.remove('show');\n            this.drawerElement.setAttribute('tabindex', '-1');\n\n            // Update toggle button aria-expanded.\n            if (this.toggleButton) {\n                this.toggleButton.setAttribute('aria-expanded', 'false');\n            }\n\n            // Remove padding from page - uses this.pageClass.\n            if (this.pageElement && this.pageElement.classList.contains(this.pageClass)) {\n                this.pageElement.classList.remove(this.pageClass);\n            }\n\n            // Remove class from body.\n            if (this.bodyElement && this.bodyElement.classList.contains(this.bodyClass)) {\n                this.bodyElement.classList.remove(this.bodyClass);\n            }\n\n            // Focus management.\n            if (this.jumpTo) {\n                this.jumpTo.setAttribute('tabindex', -1);\n            }\n            if (this.toggleButton) {\n                this.toggleButton.focus();\n            }\n        }\n\n        toggleDrawer() {\n            console.log(\"Toggle drawer\");\n            if (this.isDrawerOpen()) {\n                console.log(\"Drawer is open\");\n                this.closeDrawer();\n            } else {\n                console.log(\"Open drawer\");\n                this.openDrawer();\n            }\n        }\n\n        /**\n         * Load chat history from API\n         */\n        loadChatHistory() {\n            console.log(\"Loading chat history\");\n            //if (this.isLoadingHistory || !this.hasMoreHistory || !this.currentSessionId) {\n                //console.log(\"Current sessionId is missing\");\n                //return;\n            //}\n\n            this.isLoadingHistory = true;\n\n            // Get current scroll position and height to maintain position after loading\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n            const scrollHeightBefore = messagesContainer[0].scrollHeight;\n            const scrollTopBefore = messagesContainer[0].scrollTop;\n\n            // Show loading indicator at top\n            this.showHistoryLoading();\n\n            const requests = Ajax.call([{\n                methodname: \"local_dttutor_get_chat_history\",\n                args: {\n                    courseid: parseInt(this.courseId, 10),\n                    limit: this.historyLimit,\n                    offset: this.historyOffset\n                },\n            }]);\n\n            requests[0]\n                .then((data) => {\n                    this.hideHistoryLoading();\n\n                    if (data.success && data.messages && data.messages.length > 0) {\n                        const isInitialLoad = this.historyOffset === 0;\n\n                        // Display messages\n                        this.displayHistoryMessages(data.messages, isInitialLoad);\n\n                        // Update pagination state\n                        this.historyOffset += data.messages.length;\n                        this.hasMoreHistory = data.pagination.has_more;\n\n                        if (isInitialLoad) {\n                            // Scroll to bottom to show newest messages\n                            this.scrollToBottom();\n                        } else {\n                            // Maintain scroll position (prevent jump)\n                            const scrollHeightAfter = messagesContainer[0].scrollHeight;\n                            const scrollDiff = scrollHeightAfter - scrollHeightBefore;\n                            messagesContainer[0].scrollTop = scrollTopBefore + scrollDiff;\n                        }\n                    } else {\n                        this.hasMoreHistory = false;\n                    }\n\n                    this.historyLoaded = true;\n                    this.isLoadingHistory = false;\n                    return data;\n                })\n                .catch((err) => {\n                    this.hideHistoryLoading();\n                    this.isLoadingHistory = false;\n                    Notification.exception(err);\n                });\n        }\n\n        /**\n         * Handle scroll event for infinity scroll\n         */\n        handleHistoryScroll() {\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n            const scrollTop = messagesContainer[0].scrollTop;\n\n            // Load more when scrolled near top (within 100px)\n            if (scrollTop < 100 && !this.isLoadingHistory && this.hasMoreHistory) {\n                this.loadChatHistory();\n            }\n        }\n\n        /**\n         * Display history messages in the chat\n         * @param {Array} messages - Array of message objects from API (ordered DESC by timestamp from backend)\n         * @param {boolean} isInitialLoad - True if this is the first load (append), false for loading older (prepend)\n         */\n        displayHistoryMessages(messages, isInitialLoad) {\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n\n            // Remove welcome message if it exists on initial load\n            if (isInitialLoad) {\n                const welcomeMessage = M.util.get_string('welcomemessage', 'local_dttutor');\n                messagesContainer.find('.tutor-ia-message.ai:contains(\"' + welcomeMessage + '\")').remove();\n            }\n\n            if (isInitialLoad) {\n                // Initial load: backend sends DESC [msg_10, msg_9, msg_8]\n                // Iterate in reverse and append to get chronological order: msg_8, msg_9, msg_10\n                for (let i = messages.length - 1; i >= 0; i--) {\n                    const messageDiv = this.createMessageElement(messages[i]);\n                    messagesContainer.append(messageDiv);\n                }\n            } else {\n                // Loading older: backend sends DESC [msg_5, msg_4, msg_3]\n                // Iterate normally and prepend to get: msg_3, msg_4, msg_5 (above existing messages)\n                messages.forEach(msg => {\n                    const messageDiv = this.createMessageElement(msg);\n                    messagesContainer.prepend(messageDiv);\n                });\n            }\n        }\n\n        /**\n         * Create a message element\n         * @param {Object} msg - Message object\n         * @returns {jQuery} Message element\n         */\n        createMessageElement(msg) {\n            const messageDiv = $('<div>')\n                .addClass('tutor-ia-message')\n                .addClass(msg.role === 'user' ? 'user' : 'ai')\n                .attr('data-message-id', msg.id);\n\n            const contentDiv = $('<div>')\n                .addClass('message-content')\n                .text(msg.content);\n\n            const timestampDiv = $('<div>')\n                .addClass('message-timestamp')\n                .text(this.formatTimestamp(msg.timestamp));\n\n            messageDiv.append(contentDiv);\n            messageDiv.append(timestampDiv);\n\n            return messageDiv;\n        }\n\n        /**\n         * Format Unix timestamp to readable time\n         * @param {number} timestamp - Unix timestamp\n         * @returns {string} Formatted time string\n         */\n        formatTimestamp(timestamp) {\n            const date = new Date(timestamp * 1000);\n            const hours = date.getHours().toString().padStart(2, '0');\n            const minutes = date.getMinutes().toString().padStart(2, '0');\n            return `${hours}:${minutes}`;\n        }\n\n        /**\n         * Show loading indicator at top of messages\n         */\n        showHistoryLoading() {\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n            if (!messagesContainer.find('.history-loading').length) {\n                const loadingDiv = $('<div>')\n                    .addClass('history-loading')\n                    .text('Loading...');\n                messagesContainer.prepend(loadingDiv);\n            }\n        }\n\n        /**\n         * Hide loading indicator\n         */\n        hideHistoryLoading() {\n            this.root.find('.history-loading').remove();\n        }\n\n        sendMessage() {\n            const input = this.root.find(SELECTORS.INPUT);\n            const sendBtn = this.root.find(SELECTORS.SEND_BTN);\n\n            const messageText = input.val().trim();\n            if (!messageText || this.streaming) {\n                return;\n            }\n\n            if (messageText.length > 4000) {\n                this.addMessage('[Error] Message is too long. Maximum 4000 characters.', 'ai');\n                return;\n            }\n\n            try {\n                this.closeCurrentStream();\n                sendBtn.prop('disabled', true);\n\n                this.addMessage(messageText, 'user');\n                input.val('');\n                input.css('height', 'auto');\n                this.scrollToBottom();\n                this.showTypingIndicator();\n\n                // Build metadata object with contextual information.\n                const metaData = {\n                    user_role: 'Student',\n                    timestamp: Math.floor(Date.now() / 1000)\n                };\n\n                // Add page information if available.\n                if (this.pageContext.pagetype) {\n                    metaData.page = this.pageContext.pagetype;\n                }\n\n                // Add specific contextual parameters.\n                if (this.pageContext.discussionid) {\n                    metaData.discussionid = this.pageContext.discussionid;\n                }\n                if (this.pageContext.forumid) {\n                    metaData.forumid = this.pageContext.forumid;\n                }\n                if (this.pageContext.attemptid) {\n                    metaData.attemptid = this.pageContext.attemptid;\n                }\n                if (this.pageContext.assignid) {\n                    metaData.assignid = this.pageContext.assignid;\n                }\n                if (this.pageContext.pageid) {\n                    metaData.pageid = this.pageContext.pageid;\n                }\n                if (this.cmId) {\n                    metaData.cmid = parseInt(this.cmId, 10);\n                }\n\n                const requests = Ajax.call([{\n                    methodname: \"local_dttutor_create_chat_message\",\n                    args: {\n                        courseid: parseInt(this.courseId, 10),\n                        message: this.sanitizeString(messageText.substring(0, 4000)),\n                        meta: JSON.stringify(metaData)\n                    },\n                }]);\n\n                requests[0]\n                    .then((data) => {\n                        if (!data || !data.stream_url) {\n                            throw new Error('Stream URL missing in response');\n                        }\n                        this.currentSessionId = data.session_id;\n                        this.startSSE(data.stream_url, sendBtn);\n                        return data;\n                    })\n                    .catch((err) => {\n                        this.hideTypingIndicator();\n                        this.addMessage('[Error] ' + (err.message || 'Unknown error'), 'ai');\n                        sendBtn.prop('disabled', false);\n                        Notification.exception(err);\n                    });\n            } catch (error) {\n                this.hideTypingIndicator();\n                this.addMessage('[Error] Internal error: ' + error.message, 'ai');\n                sendBtn.prop('disabled', false);\n            }\n        }\n\n        startSSE(streamUrl, sendBtn) {\n            try {\n                const es = new EventSource(streamUrl);\n                this.currentEventSource = es;\n                this.streaming = true;\n                let firstToken = true;\n                let messageCompleted = false; // Flag to track if message completed successfully.\n\n                es.addEventListener('token', (ev) => {\n                    try {\n                        const payload = JSON.parse(ev.data);\n                        const text = payload.t || payload.content || '';\n\n                        if (firstToken) {\n                            firstToken = false;\n                            this.ensureAIMessageEl();\n                            this.hideTypingIndicator();\n                        }\n                        this.appendToAIMessage(text);\n                    } catch (e) {\n                        // Invalid token data, skip\n                    }\n                });\n\n                // Listen for 'done' event (server sends 'done', not 'message_completed').\n                es.addEventListener('done', () => {\n                    messageCompleted = true; // Mark that message completed successfully.\n                    this.finalizeStream(sendBtn);\n                });\n\n                // Maintain compatibility with 'message_completed' in case server changes.\n                es.addEventListener('message_completed', () => {\n                    messageCompleted = true;\n                    this.finalizeStream(sendBtn);\n                });\n\n                es.addEventListener('error', () => {\n                    // Only show error if message did NOT complete successfully.\n                    if (!messageCompleted) {\n                        this.appendToAIMessage('\\n[Connection interrupted]');\n                        this.finalizeStream(sendBtn);\n                    }\n                    // If messageCompleted=true, error is expected (normal closure after completion).\n                });\n            } catch (error) {\n                this.addMessage('[Error] Could not establish SSE connection', 'ai');\n                this.finalizeStream(sendBtn);\n            }\n        }\n\n        ensureAIMessageEl() {\n            if (this.currentAIMessageEl) {\n                return this.currentAIMessageEl;\n            }\n\n            const messages = this.root.find(SELECTORS.MESSAGES);\n            let el = messages.find('.tutor-ia-typing');\n\n            if (el.length) {\n                el.removeClass('tutor-ia-typing');\n                el.addClass('tutor-ia-message ai');\n                el.html('');\n            } else {\n                el = $('<div class=\"tutor-ia-message ai\"></div>');\n                messages.append(el);\n            }\n\n            this.currentAIMessageEl = el[0];\n            return this.currentAIMessageEl;\n        }\n\n        appendToAIMessage(text) {\n            if (!this.currentAIMessageEl) {\n                this.ensureAIMessageEl();\n            }\n            if (!this.currentAIMessageEl || typeof text !== 'string') {\n                return;\n            }\n\n            const currentText = this.currentAIMessageEl.textContent || '';\n            const maxLength = 10000;\n\n            if (currentText.length + text.length > maxLength) {\n                const remaining = maxLength - currentText.length;\n                if (remaining > 0) {\n                    this.currentAIMessageEl.textContent += text.substring(0, remaining) + '...';\n                }\n                return;\n            }\n\n            this.currentAIMessageEl.textContent += text;\n            this.scrollToBottom();\n        }\n\n        addMessage(text, type) {\n            if (!text || typeof text !== 'string') {\n                return;\n            }\n\n            const messages = this.root.find(SELECTORS.MESSAGES);\n            const messageEl = $('<div></div>')\n                .addClass('tutor-ia-message')\n                .addClass(type)\n                .text(text.substring(0, 10000));\n\n            messages.append(messageEl);\n            this.scrollToBottom();\n        }\n\n        showTypingIndicator() {\n            const messages = this.root.find(SELECTORS.MESSAGES);\n            if (messages.find('.tutor-ia-typing').length) {\n                return;\n            }\n\n            const typing = $('<div class=\"tutor-ia-message ai tutor-ia-typing\"></div>')\n                .html('<span class=\"dot\"></span><span class=\"dot\"></span><span class=\"dot\"></span>');\n            messages.append(typing);\n            this.scrollToBottom();\n        }\n\n        hideTypingIndicator() {\n            this.root.find('.tutor-ia-typing').remove();\n        }\n\n        scrollToBottom() {\n            const messages = this.root.find(SELECTORS.MESSAGES);\n            messages.scrollTop(messages[0].scrollHeight);\n        }\n\n        closeCurrentStream() {\n            if (this.currentEventSource) {\n                try {\n                    this.currentEventSource.close();\n                } catch (e) {\n                    // Error closing EventSource, ignore\n                }\n            }\n            this.currentEventSource = null;\n            this.streaming = false;\n            this.currentAIMessageEl = null;\n            this.hideTypingIndicator();\n        }\n\n        finalizeStream(sendBtn) {\n            this.closeCurrentStream();\n            if (sendBtn) {\n                sendBtn.prop('disabled', false);\n            }\n        }\n\n        sanitizeString(str) {\n            if (typeof str !== 'string') {\n                return '';\n            }\n            return str.replace(/[<>]/g, '');\n        }\n\n        cleanup() {\n            this.closeCurrentStream();\n        }\n\n        destroy() {\n            this.cleanup();\n        }\n    }\n\n    return {\n        init: function(root, uniqueId, courseId, cmId, userId) {\n            return new TutorIAChat(root, uniqueId, courseId, cmId, userId);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","PubSub","SELECTORS","TutorIAChat","constructor","root","uniqueId","courseId","cmId","userId","streaming","currentEventSource","currentSessionId","currentAIMessageEl","historyOffset","historyLimit","isLoadingHistory","hasMoreHistory","historyLoaded","drawerElement","document","querySelector","pageElement","bodyElement","toggleButton","closeButton","jumpTo","position","this","getAttribute","pageClass","bodyClass","pageContext","detectPageContext","init","context","M","cfg","pagetype","bodyId","body","id","replace","pathMatch","className","match","urlParams","URLSearchParams","window","location","search","includes","has","discussionid","parseInt","get","forumid","attemptid","assignid","pageid","registerEventListeners","addEventListener","cleanup","e","preventDefault","toggleDrawer","closeDrawer","find","on","sendMessage","input","key","shiftKey","style","height","Math","min","scrollHeight","handleHistoryScroll","isDrawerOpen","subscribe","focus","classList","contains","openDrawer","console","log","publish","add","setAttribute","loadChatHistory","remove","messagesContainer","scrollHeightBefore","scrollTopBefore","scrollTop","showHistoryLoading","call","methodname","args","courseid","limit","offset","then","data","hideHistoryLoading","success","messages","length","isInitialLoad","displayHistoryMessages","pagination","has_more","scrollToBottom","scrollDiff","catch","err","exception","welcomeMessage","util","get_string","i","messageDiv","createMessageElement","append","forEach","msg","prepend","addClass","role","attr","contentDiv","text","content","timestampDiv","formatTimestamp","timestamp","date","Date","hours","getHours","toString","padStart","minutes","getMinutes","loadingDiv","sendBtn","messageText","val","trim","addMessage","closeCurrentStream","prop","css","showTypingIndicator","metaData","user_role","floor","now","page","cmid","message","sanitizeString","substring","meta","JSON","stringify","stream_url","Error","session_id","startSSE","hideTypingIndicator","error","streamUrl","es","EventSource","firstToken","messageCompleted","ev","payload","parse","t","ensureAIMessageEl","appendToAIMessage","finalizeStream","el","removeClass","html","currentText","textContent","remaining","type","messageEl","typing","close","str","destroy"],"mappings":";;;;;;;AAuBAA,qCAAO,CACH,SACA,YACA,oBACA,gBACD,SACCC,EACAC,KACAC,aACAC,cAIMC,qBACU,kCADVA,iBAEM,mBAFNA,oBAGS,yBAHTA,mBAIQ,oCAJRA,gBAKK,iCALLA,mBAMQ,+BANRA,eAOI,QAPJA,kBAQO,WARPA,eASI,aAGJC,YACFC,YAAYC,KAAMC,SAAUC,SAAUC,KAAMC,aACnCJ,KAAOP,EAAEO,WACTC,SAAWA,cACXC,SAAWA,cACXC,KAAOA,UACPC,OAASA,YACTC,WAAY,OACZC,mBAAqB,UACrBC,iBAAmB,UACnBC,mBAAqB,UAGrBC,cAAgB,OAChBC,aAAe,QACfC,kBAAmB,OACnBC,gBAAiB,OACjBC,eAAgB,OAEhBC,cAAgBC,SAASC,cAAcnB,uBACvCoB,YAAcF,SAASC,cAAcnB,qBACrCqB,YAAcH,SAASC,cAAcnB,qBACrCsB,aAAeJ,SAASC,cAAcnB,2BACtCuB,YAAcL,SAASC,cAAcnB,0BACrCwB,OAASN,SAASC,cAAcnB,wBAGhCyB,SAAWC,KAAKT,eAAgBS,KAAKT,cAAcU,aAAa,kBAA8B,aAC9FC,UAA8B,SAAlBF,KAAKD,SAAsB,mBAAqB,yBAE5DI,UAA8B,SAAlBH,KAAKD,SAAsB,4BAA8B,kCAGrEK,YAAcJ,KAAKK,yBAEnBC,OAQTD,0BACUE,QAAU,MAGC,oBAANC,GAAqBA,EAAEC,KAAOD,EAAEC,IAAIC,WAC3CH,QAAQG,SAAWF,EAAEC,IAAIC,WAIxBH,QAAQG,SAAU,OACbC,OAASnB,SAASoB,KAAKC,GACzBF,SAGAJ,QAAQG,SAAWC,OAAOG,QAAQ,QAAS,SAK9CP,QAAQG,SAAU,OAGbK,UAFcvB,SAASoB,KAAKI,UAEJC,MAAM,iBAChCF,YACAR,QAAQG,SAAWK,UAAU,UAK/BG,UAAY,IAAIC,gBAAgBC,OAAOC,SAASC,eAGlDf,QAAQG,UAAYH,QAAQG,SAASa,SAAS,UAE1CL,UAAUM,IAAI,OACdjB,QAAQkB,aAAeC,SAASR,UAAUS,IAAI,KAAM,KAGpDT,UAAUM,IAAI,OACdjB,QAAQqB,QAAUF,SAASR,UAAUS,IAAI,KAAM,MAE5CpB,QAAQG,UAAYH,QAAQG,SAASa,SAAS,QAEjDL,UAAUM,IAAI,aACdjB,QAAQsB,UAAYH,SAASR,UAAUS,IAAI,WAAY,KAEpDpB,QAAQG,UAAYH,QAAQG,SAASa,SAAS,UAEjDL,UAAUM,IAAI,QACdjB,QAAQuB,SAAWJ,SAASR,UAAUS,IAAI,MAAO,KAE9CpB,QAAQG,UAAYH,QAAQG,SAASa,SAAS,SAEjDL,UAAUM,IAAI,YACdjB,QAAQwB,OAASL,SAASR,UAAUS,IAAI,UAAW,KAIpDpB,QAGXD,YACS0B,yBACLZ,OAAOa,iBAAiB,gBAAgB,IAAMjC,KAAKkC,YAGvDF,yBAEQhC,KAAKJ,mBACAA,aAAaqC,iBAAiB,SAAUE,IACzCA,EAAEC,sBACGC,kBAKTrC,KAAKH,kBACAA,YAAYoC,iBAAiB,SAAUE,IACxCA,EAAEC,sBACGE,sBAKR7D,KAAK8D,KAAKjE,oBAAoBkE,GAAG,SAAS,UACtCC,uBAIHC,MAAQ1C,KAAKvB,KAAK8D,KAAKjE,iBAC7BoE,MAAMF,GAAG,WAAYL,IACH,UAAVA,EAAEQ,KAAoBR,EAAES,WACxBT,EAAEC,sBACGK,kBAKbC,MAAMF,GAAG,SAAS,gBACTK,MAAMC,OAAS,YACfD,MAAMC,OAASC,KAAKC,IAAIhD,KAAKiD,aAAc,KAAO,QAIjCjD,KAAKvB,KAAK8D,KAAKjE,oBACvBkE,GAAG,UAAU,UACtBU,yBAIT1D,SAASyC,iBAAiB,WAAYE,IAC9BnC,KAAKmD,gBAA4B,WAAVhB,EAAEQ,UACpBL,iBAKbjE,OAAO+E,UAAU,6BAA6B,KACtCpD,KAAKmD,qBACAb,iBAKTtC,KAAKF,aACAA,OAAOmC,iBAAiB,SAAS,KAC9BjC,KAAKH,kBACAA,YAAYwD,WAMjCF,sBACWnD,KAAKT,eAAiBS,KAAKT,cAAc+D,UAAUC,SAAS,QAGvEC,aACIC,QAAQC,IAAI,sBACP1D,KAAKT,eAMVlB,OAAOsF,QAAQ,oBAAqB,SAE/BpE,cAAc+D,UAAUM,IAAI,aAC5BrE,cAAcsE,aAAa,WAAY,KAGxC7D,KAAKJ,mBACAA,aAAaiE,aAAa,gBAAiB,QAIhD7D,KAAKN,cAAgBM,KAAKN,YAAY4D,UAAUC,SAASvD,KAAKE,iBACzDR,YAAY4D,UAAUM,IAAI5D,KAAKE,WAIpCF,KAAKL,cAAgBK,KAAKL,YAAY2D,UAAUC,SAASvD,KAAKG,iBACzDR,YAAY2D,UAAUM,IAAI5D,KAAKG,WAIpCH,KAAKF,cACAA,OAAO+D,aAAa,WAAY,QAChC/D,OAAOuD,cAKPS,kBACTL,QAAQC,IAAI,eAlCRD,QAAQC,IAAI,yBAsCpBpB,cACStC,KAAKT,qBAILA,cAAc+D,UAAUS,OAAO,aAC/BxE,cAAcsE,aAAa,WAAY,MAGxC7D,KAAKJ,mBACAA,aAAaiE,aAAa,gBAAiB,SAIhD7D,KAAKN,aAAeM,KAAKN,YAAY4D,UAAUC,SAASvD,KAAKE,iBACxDR,YAAY4D,UAAUS,OAAO/D,KAAKE,WAIvCF,KAAKL,aAAeK,KAAKL,YAAY2D,UAAUC,SAASvD,KAAKG,iBACxDR,YAAY2D,UAAUS,OAAO/D,KAAKG,WAIvCH,KAAKF,aACAA,OAAO+D,aAAa,YAAa,GAEtC7D,KAAKJ,mBACAA,aAAayD,SAI1BhB,eACIoB,QAAQC,IAAI,iBACR1D,KAAKmD,gBACLM,QAAQC,IAAI,uBACPpB,gBAELmB,QAAQC,IAAI,oBACPF,cAObM,kBACIL,QAAQC,IAAI,6BAMPtE,kBAAmB,QAGlB4E,kBAAoBhE,KAAKvB,KAAK8D,KAAKjE,oBACnC2F,mBAAqBD,kBAAkB,GAAGf,aAC1CiB,gBAAkBF,kBAAkB,GAAGG,eAGxCC,qBAEYjG,KAAKkG,KAAK,CAAC,CACxBC,WAAY,iCACZC,KAAM,CACFC,SAAU9C,SAAS1B,KAAKrB,SAAU,IAClC8F,MAAOzE,KAAKb,aACZuF,OAAQ1E,KAAKd,kBAIZ,GACJyF,MAAMC,eACEC,qBAEDD,KAAKE,SAAWF,KAAKG,UAAYH,KAAKG,SAASC,OAAS,EAAG,OACrDC,cAAuC,IAAvBjF,KAAKd,sBAGtBgG,uBAAuBN,KAAKG,SAAUE,oBAGtC/F,eAAiB0F,KAAKG,SAASC,YAC/B3F,eAAiBuF,KAAKO,WAAWC,SAElCH,mBAEKI,qBACF,OAGGC,WADoBtB,kBAAkB,GAAGf,aACRgB,mBACvCD,kBAAkB,GAAGG,UAAYD,gBAAkBoB,sBAGlDjG,gBAAiB,cAGrBC,eAAgB,OAChBF,kBAAmB,EACjBwF,QAEVW,OAAOC,WACCX,0BACAzF,kBAAmB,EACxBhB,aAAaqH,UAAUD,QAOnCtC,sBAC8BlD,KAAKvB,KAAK8D,KAAKjE,oBACL,GAAG6F,UAGvB,MAAQnE,KAAKZ,kBAAoBY,KAAKX,qBAC7CyE,kBASboB,uBAAuBH,SAAUE,qBACvBjB,kBAAoBhE,KAAKvB,KAAK8D,KAAKjE,uBAGrC2G,cAAe,OACTS,eAAiBlF,EAAEmF,KAAKC,WAAW,iBAAkB,iBAC3D5B,kBAAkBzB,KAAK,kCAAoCmD,eAAiB,MAAM3B,YAGlFkB,kBAGK,IAAIY,EAAId,SAASC,OAAS,EAAGa,GAAK,EAAGA,IAAK,OACrCC,WAAa9F,KAAK+F,qBAAqBhB,SAASc,IACtD7B,kBAAkBgC,OAAOF,iBAK7Bf,SAASkB,SAAQC,YACPJ,WAAa9F,KAAK+F,qBAAqBG,KAC7ClC,kBAAkBmC,QAAQL,eAUtCC,qBAAqBG,WACXJ,WAAa5H,EAAE,SAChBkI,SAAS,oBACTA,SAAsB,SAAbF,IAAIG,KAAkB,OAAS,MACxCC,KAAK,kBAAmBJ,IAAIrF,IAE3B0F,WAAarI,EAAE,SAChBkI,SAAS,mBACTI,KAAKN,IAAIO,SAERC,aAAexI,EAAE,SAClBkI,SAAS,qBACTI,KAAKxG,KAAK2G,gBAAgBT,IAAIU,mBAEnCd,WAAWE,OAAOO,YAClBT,WAAWE,OAAOU,cAEXZ,WAQXa,gBAAgBC,iBACNC,KAAO,IAAIC,KAAiB,IAAZF,WAChBG,MAAQF,KAAKG,WAAWC,WAAWC,SAAS,EAAG,KAC/CC,QAAUN,KAAKO,aAAaH,WAAWC,SAAS,EAAG,qBAC/CH,kBAASI,SAMvB/C,2BACUJ,kBAAoBhE,KAAKvB,KAAK8D,KAAKjE,wBACpC0F,kBAAkBzB,KAAK,oBAAoByC,OAAQ,OAC9CqC,WAAanJ,EAAE,SAChBkI,SAAS,mBACTI,KAAK,cACVxC,kBAAkBmC,QAAQkB,aAOlCxC,0BACSpG,KAAK8D,KAAK,oBAAoBwB,SAGvCtB,oBACUC,MAAQ1C,KAAKvB,KAAK8D,KAAKjE,iBACvBgJ,QAAUtH,KAAKvB,KAAK8D,KAAKjE,oBAEzBiJ,YAAc7E,MAAM8E,MAAMC,UAC3BF,cAAevH,KAAKlB,aAIrByI,YAAYvC,OAAS,SAChB0C,WAAW,wDAAyD,oBAKpEC,qBACLL,QAAQM,KAAK,YAAY,QAEpBF,WAAWH,YAAa,QAC7B7E,MAAM8E,IAAI,IACV9E,MAAMmF,IAAI,SAAU,aACfxC,sBACAyC,4BAGCC,SAAW,CACbC,UAAW,UACXpB,UAAW7D,KAAKkF,MAAMnB,KAAKoB,MAAQ,MAInClI,KAAKI,YAAYM,WACjBqH,SAASI,KAAOnI,KAAKI,YAAYM,UAIjCV,KAAKI,YAAYqB,eACjBsG,SAAStG,aAAezB,KAAKI,YAAYqB,cAEzCzB,KAAKI,YAAYwB,UACjBmG,SAASnG,QAAU5B,KAAKI,YAAYwB,SAEpC5B,KAAKI,YAAYyB,YACjBkG,SAASlG,UAAY7B,KAAKI,YAAYyB,WAEtC7B,KAAKI,YAAY0B,WACjBiG,SAASjG,SAAW9B,KAAKI,YAAY0B,UAErC9B,KAAKI,YAAY2B,SACjBgG,SAAShG,OAAS/B,KAAKI,YAAY2B,QAEnC/B,KAAKpB,OACLmJ,SAASK,KAAO1G,SAAS1B,KAAKpB,KAAM,KAGvBT,KAAKkG,KAAK,CAAC,CACxBC,WAAY,oCACZC,KAAM,CACFC,SAAU9C,SAAS1B,KAAKrB,SAAU,IAClC0J,QAASrI,KAAKsI,eAAef,YAAYgB,UAAU,EAAG,MACtDC,KAAMC,KAAKC,UAAUX,cAIpB,GACJpD,MAAMC,WACEA,OAASA,KAAK+D,iBACT,IAAIC,MAAM,8CAEf5J,iBAAmB4F,KAAKiE,gBACxBC,SAASlE,KAAK+D,WAAYrB,SACxB1C,QAEVW,OAAOC,WACCuD,2BACArB,WAAW,YAAclC,IAAI6C,SAAW,iBAAkB,MAC/Df,QAAQM,KAAK,YAAY,GACzBxJ,aAAaqH,UAAUD,QAEjC,MAAOwD,YACAD,2BACArB,WAAW,2BAA6BsB,MAAMX,QAAS,MAC5Df,QAAQM,KAAK,YAAY,IAIjCkB,SAASG,UAAW3B,mBAEN4B,GAAK,IAAIC,YAAYF,gBACtBlK,mBAAqBmK,QACrBpK,WAAY,MACbsK,YAAa,EACbC,kBAAmB,EAEvBH,GAAGjH,iBAAiB,SAAUqH,eAEhBC,QAAUd,KAAKe,MAAMF,GAAG1E,MACxB4B,KAAO+C,QAAQE,GAAKF,QAAQ9C,SAAW,GAEzC2C,aACAA,YAAa,OACRM,yBACAX,4BAEJY,kBAAkBnD,MACzB,MAAOrE,QAMb+G,GAAGjH,iBAAiB,QAAQ,KACxBoH,kBAAmB,OACdO,eAAetC,YAIxB4B,GAAGjH,iBAAiB,qBAAqB,KACrCoH,kBAAmB,OACdO,eAAetC,YAGxB4B,GAAGjH,iBAAiB,SAAS,KAEpBoH,wBACIM,kBAAkB,mCAClBC,eAAetC,aAI9B,MAAO0B,YACAtB,WAAW,6CAA8C,WACzDkC,eAAetC,UAI5BoC,uBACQ1J,KAAKf,0BACEe,KAAKf,yBAGV8F,SAAW/E,KAAKvB,KAAK8D,KAAKjE,wBAC5BuL,GAAK9E,SAASxC,KAAK,2BAEnBsH,GAAG7E,QACH6E,GAAGC,YAAY,mBACfD,GAAGzD,SAAS,uBACZyD,GAAGE,KAAK,MAERF,GAAK3L,EAAE,2CACP6G,SAASiB,OAAO6D,UAGf5K,mBAAqB4K,GAAG,GACtB7J,KAAKf,mBAGhB0K,kBAAkBnD,SACTxG,KAAKf,yBACDyK,qBAEJ1J,KAAKf,oBAAsC,iBAATuH,kBAIjCwD,YAAchK,KAAKf,mBAAmBgL,aAAe,MAGvDD,YAAYhF,OAASwB,KAAKxB,OAFZ,WAGRkF,UAHQ,IAGgBF,YAAYhF,OACtCkF,UAAY,SACPjL,mBAAmBgL,aAAezD,KAAK+B,UAAU,EAAG2B,WAAa,iBAKzEjL,mBAAmBgL,aAAezD,UAClCnB,iBAGTqC,WAAWlB,KAAM2D,UACR3D,MAAwB,iBAATA,kBAIdzB,SAAW/E,KAAKvB,KAAK8D,KAAKjE,oBAC1B8L,UAAYlM,EAAE,eACfkI,SAAS,oBACTA,SAAS+D,MACT3D,KAAKA,KAAK+B,UAAU,EAAG,MAE5BxD,SAASiB,OAAOoE,gBACX/E,iBAGTyC,4BACU/C,SAAW/E,KAAKvB,KAAK8D,KAAKjE,uBAC5ByG,SAASxC,KAAK,oBAAoByC,oBAIhCqF,OAASnM,EAAE,2DACZ6L,KAAK,+EACVhF,SAASiB,OAAOqE,aACXhF,iBAGT0D,2BACStK,KAAK8D,KAAK,oBAAoBwB,SAGvCsB,uBACUN,SAAW/E,KAAKvB,KAAK8D,KAAKjE,oBAChCyG,SAASZ,UAAUY,SAAS,GAAG9B,cAGnC0E,wBACQ3H,KAAKjB,4BAEIA,mBAAmBuL,QAC1B,MAAOnI,SAIRpD,mBAAqB,UACrBD,WAAY,OACZG,mBAAqB,UACrB8J,sBAGTa,eAAetC,cACNK,qBACDL,SACAA,QAAQM,KAAK,YAAY,GAIjCU,eAAeiC,WACQ,iBAARA,IACA,GAEJA,IAAIzJ,QAAQ,QAAS,IAGhCoB,eACSyF,qBAGT6C,eACStI,iBAIN,CACH5B,KAAM,SAAS7B,KAAMC,SAAUC,SAAUC,KAAMC,eACpC,IAAIN,YAAYE,KAAMC,SAAUC,SAAUC,KAAMC"}