{"version":3,"file":"tutor_ia_chat.min.js","sources":["../src/tutor_ia_chat.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tutor-IA Chat - Drawer and chat functionality (based on aiplacement_courseassist)\n *\n * @module     local_dttutor/tutor_ia_chat\n * @copyright  2025 Datacurso\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'core/pubsub',\n    'local_dttutor/error_modal'\n], function(\n    $,\n    Ajax,\n    Notification,\n    PubSub,\n    ErrorModal\n) {\n    'use strict';\n\n    const SELECTORS = {\n        TOGGLE_BTN: '[data-action=\"tutor-ia-toggle\"]',\n        DRAWER: '.tutor-ia-drawer',\n        CLOSE_BTN: '.tutor-ia-close-button',\n        MESSAGES: '[data-region=\"tutor-ia-messages\"]',\n        INPUT: '[data-region=\"tutor-ia-input\"]',\n        SEND_BTN: '[data-action=\"send-message\"]',\n        PAGE: '#page',\n        JUMP_TO: '#jump-to',\n        BODY: 'body'\n    };\n\n    class TutorIAChat {\n        constructor(root, uniqueId, courseId, cmId, userId) {\n            this.root = $(root);\n            this.uniqueId = uniqueId;\n            this.courseId = courseId;\n            this.cmId = cmId;\n            this.userId = userId;\n            this.streaming = false;\n            this.currentEventSource = null;\n            this.currentSessionId = null;\n            this.currentAIMessageEl = null;\n            this.currentAIMessageContainer = null;\n\n            // Text selection state\n            this.selectedText = '';\n            this.selectionLineCount = 0;\n            this.selectionCharCount = 0;\n            this.highlightedRange = null; // Reference to the highlighted range for visual persistence\n\n            // History pagination state\n            this.historyOffset = 0;\n            this.historyLimit = 20;\n            this.isLoadingHistory = false;\n            this.hasMoreHistory = true;\n            this.historyLoaded = false;\n\n            // Get welcome message from data attribute\n            this.welcomeMessage = root.getAttribute('data-welcomemessage') || '';\n\n            // Check if webservice is configured\n            this.isConfigured = root.getAttribute('data-is-configured') === '1' ||\n                                root.getAttribute('data-is-configured') === 'true';\n\n            this.drawerElement = document.querySelector(SELECTORS.DRAWER);\n            this.pageElement = document.querySelector(SELECTORS.PAGE);\n            this.bodyElement = document.querySelector(SELECTORS.BODY);\n            this.toggleButton = document.querySelector(SELECTORS.TOGGLE_BTN);\n            this.closeButton = document.querySelector(SELECTORS.CLOSE_BTN);\n            this.jumpTo = document.querySelector(SELECTORS.JUMP_TO);\n\n            // Detect drawer position (right/left) from data-position.\n            this.position = this.drawerElement ? this.drawerElement.getAttribute('data-position') || 'right' : 'right';\n            this.pageClass = this.position === 'left' ? 'show-drawer-left' : 'show-drawer-right';\n            // Class to identify that Tutor-IA drawer is open (to move footer-popover).\n            this.bodyClass = this.position === 'left' ? 'tutor-ia-drawer-open-left' : 'tutor-ia-drawer-open-right';\n\n            // Capture contextual information from the page.\n            this.pageContext = this.detectPageContext();\n\n            // Adjust drawer top position based on navbar height.\n            this.adjustDrawerTopPosition();\n\n            this.init();\n        }\n\n        /**\n         * Adjusts the drawer top position based on the navbar height.\n         * This ensures compatibility with different Moodle themes that may have\n         * different navbar heights (e.g., 60px, 80px, etc.).\n         */\n        adjustDrawerTopPosition() {\n            if (!this.drawerElement) {\n                return;\n            }\n\n            // Try to find the navbar using common Moodle selectors.\n            const navbarSelectors = [\n                '.navbar.fixed-top',\n                '.fixed-top.navbar',\n                '#page-header.fixed-top',\n                'nav.fixed-top',\n                '.navbar-fixed-top'\n            ];\n\n            let navbarHeight = 60; // Default fallback height.\n\n            for (const selector of navbarSelectors) {\n                const navbar = document.querySelector(selector);\n                if (navbar) {\n                    // Get the computed height including padding and border.\n                    navbarHeight = navbar.offsetHeight;\n\n                    // If the navbar is hidden or has 0 height, skip it.\n                    if (navbarHeight > 0) {\n                        break;\n                    }\n                }\n            }\n\n            // Set the CSS variable for drawer top position.\n            this.drawerElement.style.setProperty('--tutor-ia-drawer-top', navbarHeight + 'px');\n\n            // Also listen for window resize to recalculate if needed.\n            window.addEventListener('resize', () => {\n                const navbar = document.querySelector(navbarSelectors[0]);\n                if (navbar) {\n                    const newHeight = navbar.offsetHeight;\n                    this.drawerElement.style.setProperty('--tutor-ia-drawer-top', newHeight + 'px');\n                }\n            });\n        }\n\n        /**\n         * Detects the current page context (page type and relevant parameters).\n         *\n         * @returns {Object} Object with page contextual information\n         */\n        detectPageContext() {\n            const context = {};\n\n            // Method 1: Try to get pagetype from M.cfg.\n            if (typeof M !== 'undefined' && M.cfg && M.cfg.pagetype) {\n                context.pagetype = M.cfg.pagetype;\n            }\n\n            // Method 2: If not available, use body id/class (more reliable).\n            if (!context.pagetype) {\n                const bodyId = document.body.id;\n                if (bodyId) {\n                    // Body id format: \"page-mod-forum-discuss\" or \"page-course-view-topics\".\n                    // Extract the part after \"page-\".\n                    context.pagetype = bodyId.replace('page-', '');\n                }\n            }\n\n            // Method 3: Fallback using body classes.\n            if (!context.pagetype) {\n                const bodyClasses = document.body.className;\n                // Look for classes with format \"path-mod-forum\", \"pagelayout-incourse\", etc.\n                const pathMatch = bodyClasses.match(/path-([\\w-]+)/);\n                if (pathMatch) {\n                    context.pagetype = pathMatch[1];\n                }\n            }\n\n            // Get URL parameters.\n            const urlParams = new URLSearchParams(window.location.search);\n\n            // Extract common parameters based on page type.\n            if (context.pagetype && context.pagetype.includes('forum')) {\n                // Forum discussion ID.\n                if (urlParams.has('d')) {\n                    context.discussionid = parseInt(urlParams.get('d'), 10);\n                }\n                // Forum ID.\n                if (urlParams.has('f')) {\n                    context.forumid = parseInt(urlParams.get('f'), 10);\n                }\n            } else if (context.pagetype && context.pagetype.includes('quiz')) {\n                // Quiz attempt ID.\n                if (urlParams.has('attempt')) {\n                    context.attemptid = parseInt(urlParams.get('attempt'), 10);\n                }\n            } else if (context.pagetype && context.pagetype.includes('assign')) {\n                // Assignment ID.\n                if (urlParams.has('id')) {\n                    context.assignid = parseInt(urlParams.get('id'), 10);\n                }\n            } else if (context.pagetype && context.pagetype.includes('wiki')) {\n                // Wiki page ID.\n                if (urlParams.has('pageid')) {\n                    context.pageid = parseInt(urlParams.get('pageid'), 10);\n                }\n            }\n\n            return context;\n        }\n\n        init() {\n            this.registerEventListeners();\n            window.addEventListener('beforeunload', () => this.cleanup());\n        }\n\n        registerEventListeners() {\n            // Toggle button.\n            if (this.toggleButton) {\n                this.toggleButton.addEventListener('click', (e) => {\n                    e.preventDefault();\n                    this.toggleDrawer();\n                });\n            }\n\n            // Close button.\n            if (this.closeButton) {\n                this.closeButton.addEventListener('click', (e) => {\n                    e.preventDefault();\n                    this.closeDrawer();\n                });\n            }\n\n            // Send button.\n            this.root.find(SELECTORS.SEND_BTN).on('click', () => {\n                this.sendMessage();\n            });\n\n            // Input - Enter to send.\n            const input = this.root.find(SELECTORS.INPUT);\n            input.on('keydown', (e) => {\n                if (e.key === 'Enter' && !e.shiftKey) {\n                    e.preventDefault();\n                    this.sendMessage();\n                }\n            });\n\n            // Auto-resize textarea.\n            input.on('input', function() {\n                this.style.height = 'auto';\n                this.style.height = Math.min(this.scrollHeight, 120) + 'px';\n            });\n\n            // Infinity scroll for history\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n            messagesContainer.on('scroll', () => {\n                this.handleHistoryScroll();\n            });\n\n            // Close on Escape key.\n            document.addEventListener('keydown', (e) => {\n                if (this.isDrawerOpen() && e.key === 'Escape') {\n                    this.closeDrawer();\n                }\n            });\n\n            // Close drawer if message drawer opens.\n            PubSub.subscribe('core_message/drawer_shown', () => {\n                if (this.isDrawerOpen()) {\n                    this.closeDrawer();\n                }\n            });\n\n            // Jump to functionality.\n            if (this.jumpTo) {\n                this.jumpTo.addEventListener('focus', () => {\n                    if (this.closeButton) {\n                        this.closeButton.focus();\n                    }\n                });\n            }\n\n            // Text selection handler.\n            document.addEventListener('mouseup', () => {\n                this.handleTextSelection();\n            });\n\n            // Also handle keyboard selection (Shift + Arrow keys, Ctrl+A, etc.)\n            document.addEventListener('keyup', (e) => {\n                if (e.shiftKey || e.ctrlKey || e.metaKey) {\n                    this.handleTextSelection();\n                }\n            });\n\n            // Clear selection button.\n            this.root.find('[data-action=\"clear-selection\"]').on('click', () => {\n                this.clearSelection();\n                // Also clear browser selection\n                if (window.getSelection) {\n                    window.getSelection().removeAllRanges();\n                }\n            });\n        }\n\n        /**\n         * Handles text selection on the page.\n         * Captures selected text and updates the internal state.\n         *\n         * IMPORTANT: Only updates when new text is selected.\n         * Does NOT clear existing selection when user clicks elsewhere (like the chat input).\n         * Selection is only cleared when:\n         * - User clicks the X button\n         * - User sends a message\n         * - User selects new text (replaces old selection)\n         */\n        handleTextSelection() {\n            const selection = window.getSelection();\n            const selectedText = selection ? selection.toString().trim() : '';\n\n            // Only update if there is actual text selected.\n            // Do NOT clear existing selection if user just clicked somewhere else.\n            if (selectedText && selectedText.length > 0) {\n                // Remove any previous highlight before creating new one.\n                this.removeHighlight();\n\n                // Store the selected text.\n                this.selectedText = selectedText;\n\n                // Count lines (split by newlines).\n                this.selectionLineCount = selectedText.split('\\n').length;\n\n                // Count characters.\n                this.selectionCharCount = selectedText.length;\n\n                // Apply persistent visual highlighting.\n                this.applyHighlight(selection);\n\n                // Update UI indicator.\n                this.updateSelectionIndicator();\n            }\n            // Note: We intentionally do NOT call clearSelection() here.\n            // Selection persists until explicitly cleared by user action.\n        }\n\n        /**\n         * Updates the selection indicator in the chat UI.\n         */\n        updateSelectionIndicator() {\n            const indicator = this.root.find('[data-region=\"selection-indicator\"]');\n            const countElement = this.root.find('[data-region=\"selection-count\"]');\n\n            if (!indicator.length || !countElement.length) {\n                return;\n            }\n\n            if (this.selectedText && this.selectedText.length > 0 && this.selectionLineCount > 0) {\n                // Show indicator with count (lines and characters)\n                const lineText = this.selectionLineCount === 1 ? 'line' : 'lines';\n                const charText = this.selectionCharCount === 1 ? 'char' : 'chars';\n                countElement.text(`${this.selectionLineCount} ${lineText}, ${this.selectionCharCount} ${charText} selected`);\n                indicator.show();\n            } else {\n                // Hide indicator\n                indicator.hide();\n            }\n        }\n\n        /**\n         * Clears the text selection state.\n         */\n        clearSelection() {\n            this.selectedText = '';\n            this.selectionLineCount = 0;\n            this.selectionCharCount = 0;\n\n            // Remove visual highlight.\n            this.removeHighlight();\n\n            // Update UI indicator (if it exists).\n            this.updateSelectionIndicator();\n        }\n\n        /**\n         * Applies persistent visual highlighting to the selected text.\n         * Wraps the selected range in a styled span element that persists after focus loss.\n         *\n         * @param {Selection} selection - The browser Selection object containing the current selection\n         */\n        applyHighlight(selection) {\n            if (!selection || selection.rangeCount === 0) {\n                return;\n            }\n\n            try {\n                // Get the first range from the selection.\n                const range = selection.getRangeAt(0);\n\n                // Create a span element to wrap the selected text.\n                const highlightSpan = document.createElement('span');\n                highlightSpan.className = 'tutor-ia-text-highlight';\n                highlightSpan.setAttribute('data-tutor-ia-highlight', 'true');\n\n                // Wrap the range contents in the highlight span.\n                // This extracts the contents and places them in the span.\n                highlightSpan.appendChild(range.extractContents());\n\n                // Insert the highlighted span at the range position.\n                range.insertNode(highlightSpan);\n\n                // Store reference to the highlighted element for later removal.\n                this.highlightedRange = highlightSpan;\n            } catch (e) {\n                // Silently handle errors (e.g., selection in non-editable area).\n                window.console.warn('Failed to apply text highlight:', e);\n            }\n        }\n\n        /**\n         * Removes the persistent visual highlighting from the page.\n         * Unwraps the highlighted span and restores original text nodes.\n         */\n        removeHighlight() {\n            if (!this.highlightedRange) {\n                return;\n            }\n\n            try {\n                // Get the parent of the highlight span.\n                const parent = this.highlightedRange.parentNode;\n\n                if (parent) {\n                    // Move all child nodes of the span back to the parent.\n                    while (this.highlightedRange.firstChild) {\n                        parent.insertBefore(this.highlightedRange.firstChild, this.highlightedRange);\n                    }\n\n                    // Remove the now-empty highlight span.\n                    parent.removeChild(this.highlightedRange);\n\n                    // Normalize the parent to merge adjacent text nodes.\n                    parent.normalize();\n                }\n            } catch (e) {\n                // Silently handle errors (e.g., element already removed).\n                window.console.warn('Failed to remove text highlight:', e);\n            } finally {\n                // Clear the reference regardless of success.\n                this.highlightedRange = null;\n            }\n        }\n\n        isDrawerOpen() {\n            return this.drawerElement && this.drawerElement.classList.contains('show');\n        }\n\n        openDrawer() {\n            if (!this.drawerElement) {\n                return;\n            }\n\n            // Close message drawer if open.\n            PubSub.publish('core_message/hide', {});\n\n            this.drawerElement.classList.add('show');\n            this.drawerElement.setAttribute('tabindex', '0');\n\n            // Update toggle button aria-expanded.\n            if (this.toggleButton) {\n                this.toggleButton.setAttribute('aria-expanded', 'true');\n            }\n\n            // Add padding to page (redistribute space) - uses this.pageClass (show-drawer-left or show-drawer-right).\n            if (this.pageElement && !this.pageElement.classList.contains(this.pageClass)) {\n                this.pageElement.classList.add(this.pageClass);\n            }\n\n            // Add class to body to identify Tutor-IA drawer is open (for footer-popover positioning).\n            if (this.bodyElement && !this.bodyElement.classList.contains(this.bodyClass)) {\n                this.bodyElement.classList.add(this.bodyClass);\n            }\n\n            // Focus management.\n            if (this.jumpTo) {\n                this.jumpTo.setAttribute('tabindex', 0);\n                this.jumpTo.focus();\n            }\n\n            // Load chat history on first open (only if configured)\n            if (this.isConfigured) {\n                this.loadChatHistory();\n            }\n        }\n\n        closeDrawer() {\n            if (!this.drawerElement) {\n                return;\n            }\n\n            this.drawerElement.classList.remove('show');\n            this.drawerElement.setAttribute('tabindex', '-1');\n\n            // Update toggle button aria-expanded.\n            if (this.toggleButton) {\n                this.toggleButton.setAttribute('aria-expanded', 'false');\n            }\n\n            // Remove padding from page - uses this.pageClass.\n            if (this.pageElement && this.pageElement.classList.contains(this.pageClass)) {\n                this.pageElement.classList.remove(this.pageClass);\n            }\n\n            // Remove class from body.\n            if (this.bodyElement && this.bodyElement.classList.contains(this.bodyClass)) {\n                this.bodyElement.classList.remove(this.bodyClass);\n            }\n\n            // Focus management.\n            if (this.jumpTo) {\n                this.jumpTo.setAttribute('tabindex', -1);\n            }\n            if (this.toggleButton) {\n                this.toggleButton.focus();\n            }\n        }\n\n        toggleDrawer() {\n            if (this.isDrawerOpen()) {\n                this.closeDrawer();\n            } else {\n                this.openDrawer();\n            }\n        }\n\n        /**\n         * Load chat history from API\n         */\n        loadChatHistory() {\n            // Skip if already loading, no more history, or no session yet\n            if (this.isLoadingHistory || !this.hasMoreHistory) {\n                return;\n            }\n\n            this.isLoadingHistory = true;\n\n            // Get current scroll position and height to maintain position after loading\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n            const scrollHeightBefore = messagesContainer[0].scrollHeight;\n            const scrollTopBefore = messagesContainer[0].scrollTop;\n\n            // Show loading indicator at top\n            this.showHistoryLoading();\n\n            const requests = Ajax.call([{\n                methodname: \"local_dttutor_get_chat_history\",\n                args: {\n                    courseid: parseInt(this.courseId, 10),\n                    limit: this.historyLimit,\n                    offset: this.historyOffset\n                },\n            }]);\n\n            requests[0]\n                .then((data) => {\n                    this.hideHistoryLoading();\n\n                    if (data.success && data.messages && data.messages.length > 0) {\n                        const isInitialLoad = this.historyOffset === 0;\n\n                        // Display messages\n                        this.displayHistoryMessages(data.messages, isInitialLoad);\n\n                        // Update pagination state\n                        this.historyOffset += data.messages.length;\n                        this.hasMoreHistory = data.pagination.has_more;\n\n                        if (isInitialLoad) {\n                            // Scroll to bottom to show newest messages\n                            this.scrollToBottom();\n                        } else {\n                            // Maintain scroll position (prevent jump)\n                            const scrollHeightAfter = messagesContainer[0].scrollHeight;\n                            const scrollDiff = scrollHeightAfter - scrollHeightBefore;\n                            messagesContainer[0].scrollTop = scrollTopBefore + scrollDiff;\n                        }\n                    } else {\n                        this.hasMoreHistory = false;\n                    }\n\n                    this.historyLoaded = true;\n                    this.isLoadingHistory = false;\n                    return data;\n                })\n                .catch((err) => {\n                    this.hideHistoryLoading();\n                    this.isLoadingHistory = false;\n\n                    // Show error in modal instead of notification\n                    const errorMessage = this.getFriendlyErrorMessage(err);\n                    const isConfigError = this.isWebserviceConfigError(err);\n                    const configUrl = this.extractConfigUrl(err);\n\n                    if (isConfigError) {\n                        ErrorModal.showConfigError(errorMessage, configUrl);\n                    } else {\n                        ErrorModal.showGeneralError(errorMessage);\n                    }\n                });\n        }\n\n        /**\n         * Handle scroll event for infinity scroll\n         */\n        handleHistoryScroll() {\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n            const scrollTop = messagesContainer[0].scrollTop;\n\n            // Load more when scrolled near top (within 100px)\n            if (scrollTop < 100 && !this.isLoadingHistory && this.hasMoreHistory) {\n                this.loadChatHistory();\n            }\n        }\n\n        /**\n         * Display history messages in the chat\n         * @param {Array} messages - Array of message objects from API (ordered DESC by timestamp from backend)\n         * @param {boolean} isInitialLoad - True if this is the first load (append), false for loading older (prepend)\n         */\n        displayHistoryMessages(messages, isInitialLoad) {\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n\n            // Remove welcome message if it exists on initial load\n            if (isInitialLoad && this.welcomeMessage) {\n                messagesContainer.find('.tutor-ia-message.ai:contains(\"' + this.welcomeMessage + '\")').remove();\n            }\n\n            if (isInitialLoad) {\n                // Initial load: backend sends DESC [msg_10, msg_9, msg_8]\n                // Iterate in reverse and append to get chronological order: msg_8, msg_9, msg_10\n                for (let i = messages.length - 1; i >= 0; i--) {\n                    const messageDiv = this.createMessageElement(messages[i]);\n                    messagesContainer.append(messageDiv);\n                }\n            } else {\n                // Loading older: backend sends DESC [msg_5, msg_4, msg_3]\n                // Iterate normally and prepend to get: msg_3, msg_4, msg_5 (above existing messages)\n                messages.forEach(msg => {\n                    const messageDiv = this.createMessageElement(msg);\n                    messagesContainer.prepend(messageDiv);\n                });\n            }\n        }\n\n        /**\n         * Create a message element\n         * @param {Object} msg - Message object\n         * @returns {jQuery} Message element\n         */\n        createMessageElement(msg) {\n            const messageDiv = $('<div>')\n                .addClass('tutor-ia-message')\n                .addClass(msg.role === 'user' ? 'user' : 'ai')\n                .attr('data-message-id', msg.id);\n\n            const contentDiv = $('<div>')\n                .addClass('message-content')\n                .text(msg.content);\n\n            const timestampDiv = $('<div>')\n                .addClass('message-timestamp')\n                .text(this.formatTimestamp(msg.timestamp));\n\n            messageDiv.append(contentDiv);\n            messageDiv.append(timestampDiv);\n\n            return messageDiv;\n        }\n\n        /**\n         * Format Unix timestamp to readable date and time\n         * @param {number} timestamp - Unix timestamp\n         * @returns {string} Formatted date and time string\n         */\n        formatTimestamp(timestamp) {\n            const date = new Date(timestamp * 1000);\n            const today = new Date();\n\n            // Reset hours to compare dates only\n            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());\n            const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());\n            const yesterday = new Date(todayDate);\n            yesterday.setDate(yesterday.getDate() - 1);\n\n            const hours = date.getHours().toString().padStart(2, '0');\n            const minutes = date.getMinutes().toString().padStart(2, '0');\n            const time = `${hours}:${minutes}`;\n\n            // If today, show only time\n            if (messageDate.getTime() === todayDate.getTime()) {\n                return time;\n            }\n\n            // If yesterday, show \"Yesterday HH:MM\"\n            if (messageDate.getTime() === yesterday.getTime()) {\n                return `Yesterday ${time}`;\n            }\n\n            // Otherwise show DD/MM/YYYY HH:MM\n            const day = date.getDate().toString().padStart(2, '0');\n            const month = (date.getMonth() + 1).toString().padStart(2, '0');\n            const year = date.getFullYear();\n            return `${day}/${month}/${year} ${time}`;\n        }\n\n        /**\n         * Show loading indicator at top of messages\n         */\n        showHistoryLoading() {\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n            if (!messagesContainer.find('.history-loading').length) {\n                const loadingDiv = $('<div>')\n                    .addClass('history-loading')\n                    .text('Loading...');\n                messagesContainer.prepend(loadingDiv);\n            }\n        }\n\n        /**\n         * Hide loading indicator\n         */\n        hideHistoryLoading() {\n            this.root.find('.history-loading').remove();\n        }\n\n        sendMessage() {\n            // Do not send messages if webservice is not configured\n            if (!this.isConfigured) {\n                return;\n            }\n\n            const input = this.root.find(SELECTORS.INPUT);\n            const sendBtn = this.root.find(SELECTORS.SEND_BTN);\n\n            const messageText = input.val().trim();\n\n            // Validation: Empty messages or streaming in progress.\n            if (!messageText || this.streaming) {\n                return;\n            }\n\n            // Validation: Message contains only a single dot.\n            if (messageText === '.') {\n                this.addMessage('[Error] Please enter a valid message.', 'ai');\n                return;\n            }\n\n            // Validation: Message exceeds maximum length.\n            if (messageText.length > 4000) {\n                this.addMessage('[Error] Message is too long. Maximum 4000 characters.', 'ai');\n                return;\n            }\n\n            try {\n                this.closeCurrentStream();\n                sendBtn.prop('disabled', true);\n\n                this.addMessage(messageText, 'user');\n                input.val('');\n                input.css('height', 'auto');\n                this.scrollToBottom();\n                this.showTypingIndicator();\n\n                const metaData = {\n                    user_role: 'Student',\n                    timestamp: Math.floor(Date.now() / 1000)\n                };\n\n                if (this.pageContext.pagetype) {\n                    metaData.page = this.pageContext.pagetype;\n                }\n\n                if (this.pageContext.discussionid) {\n                    metaData.discussionid = this.pageContext.discussionid;\n                }\n                if (this.pageContext.forumid) {\n                    metaData.forumid = this.pageContext.forumid;\n                }\n                if (this.pageContext.attemptid) {\n                    metaData.attemptid = this.pageContext.attemptid;\n                }\n                if (this.pageContext.assignid) {\n                    metaData.assignid = this.pageContext.assignid;\n                }\n                if (this.pageContext.pageid) {\n                    metaData.pageid = this.pageContext.pageid;\n                }\n                if (this.cmId) {\n                    metaData.cmid = parseInt(this.cmId, 10);\n                }\n\n                // Add selected text if present.\n                if (this.selectedText && this.selectedText.length > 0) {\n                    metaData.selected_text = this.selectedText;\n                }\n\n                const requests = Ajax.call([{\n                    methodname: \"local_dttutor_create_chat_message\",\n                    args: {\n                        courseid: parseInt(this.courseId, 10),\n                        message: this.sanitizeString(messageText.substring(0, 4000)),\n                        meta: JSON.stringify(metaData)\n                    },\n                }]);\n\n                requests[0]\n                    .then((data) => {\n                        if (!data || !data.stream_url) {\n                            throw new Error('Stream URL missing in response');\n                        }\n                        this.currentSessionId = data.session_id;\n                        this.startSSE(data.stream_url, sendBtn);\n\n                        // Clear the selection after sending the message.\n                        this.clearSelection();\n\n                        return data;\n                    })\n                    .catch((err) => {\n                        this.hideTypingIndicator();\n\n                        if (this.isNoCreditsError(err)) {\n                            const errorHtml = err.message || 'Insufficient AI credits available.';\n                            this.showNoCreditsWarning(errorHtml);\n\n                            const input = this.root.find(SELECTORS.INPUT);\n                            input.prop('disabled', true);\n                            sendBtn.prop('disabled', true);\n                        } else {\n                            sendBtn.prop('disabled', false);\n\n                            const errorMessage = this.getFriendlyErrorMessage(err);\n                            const isConfigError = this.isWebserviceConfigError(err);\n                            const configUrl = this.extractConfigUrl(err);\n\n                            if (isConfigError) {\n                                ErrorModal.showConfigError(errorMessage, configUrl);\n                            } else {\n                                ErrorModal.showGeneralError(errorMessage);\n                            }\n                        }\n                    });\n            } catch (error) {\n                this.hideTypingIndicator();\n                sendBtn.prop('disabled', false);\n                ErrorModal.showGeneralError('Internal error: ' + error.message);\n            }\n        }\n\n        startSSE(streamUrl, sendBtn) {\n            try {\n                const es = new EventSource(streamUrl);\n                this.currentEventSource = es;\n                this.streaming = true;\n                let firstToken = true;\n                let messageCompleted = false;\n\n                es.addEventListener('token', (ev) => {\n                    try {\n                        const payload = JSON.parse(ev.data);\n                        const text = payload.t || payload.content || '';\n\n                        if (firstToken) {\n                            firstToken = false;\n                            this.ensureAIMessageEl();\n                            this.hideTypingIndicator();\n                        }\n                        this.appendToAIMessage(text);\n                    } catch (e) {\n                        // Invalid token data, skip\n                    }\n                });\n\n                // Listen for 'done' event (server sends 'done', not 'message_completed').\n                es.addEventListener('done', () => {\n                    messageCompleted = true; // Mark that message completed successfully.\n                    this.finalizeStream(sendBtn);\n                });\n\n                // Maintain compatibility with 'message_completed' in case server changes.\n                es.addEventListener('message_completed', () => {\n                    messageCompleted = true;\n                    this.finalizeStream(sendBtn);\n                });\n\n                es.addEventListener('error', () => {\n                    // Only show error if message did NOT complete successfully.\n                    if (!messageCompleted) {\n                        this.appendToAIMessage('\\n[Connection interrupted]');\n                        this.finalizeStream(sendBtn);\n                    }\n                    // If messageCompleted=true, error is expected (normal closure after completion).\n                });\n            } catch (error) {\n                this.addMessage('[Error] Could not establish SSE connection', 'ai');\n                this.finalizeStream(sendBtn);\n            }\n        }\n\n        ensureAIMessageEl() {\n            if (this.currentAIMessageEl) {\n                return this.currentAIMessageEl;\n            }\n\n            const messages = this.root.find(SELECTORS.MESSAGES);\n            let messageContainer;\n\n            // Check if typing indicator exists\n            const typingEl = messages.find('.tutor-ia-typing');\n            if (typingEl.length) {\n                // Convert typing indicator to message\n                messageContainer = typingEl;\n                messageContainer.removeClass('tutor-ia-typing');\n                messageContainer.addClass('tutor-ia-message ai');\n                messageContainer.html('');\n            } else {\n                // Create new message container\n                messageContainer = $('<div class=\"tutor-ia-message ai\"></div>');\n                messages.append(messageContainer);\n            }\n\n            // Create content div for message text\n            const contentDiv = $('<div>')\n                .addClass('message-content');\n            messageContainer.append(contentDiv);\n\n            // Store reference to content div for appending text\n            this.currentAIMessageEl = contentDiv[0];\n            this.currentAIMessageContainer = messageContainer[0];\n            return this.currentAIMessageEl;\n        }\n\n        appendToAIMessage(text) {\n            if (!this.currentAIMessageEl) {\n                this.ensureAIMessageEl();\n            }\n            if (!this.currentAIMessageEl || typeof text !== 'string') {\n                return;\n            }\n\n            const currentText = this.currentAIMessageEl.textContent || '';\n            const maxLength = 10000;\n\n            if (currentText.length + text.length > maxLength) {\n                const remaining = maxLength - currentText.length;\n                if (remaining > 0) {\n                    this.currentAIMessageEl.textContent += text.substring(0, remaining) + '...';\n                }\n                return;\n            }\n\n            this.currentAIMessageEl.textContent += text;\n            this.scrollToBottom();\n        }\n\n        addMessage(text, type) {\n            if (!text || typeof text !== 'string') {\n                return;\n            }\n\n            const messages = this.root.find(SELECTORS.MESSAGES);\n\n            // Create message container\n            const messageEl = $('<div></div>')\n                .addClass('tutor-ia-message')\n                .addClass(type);\n\n            // Add message content\n            const contentDiv = $('<div>')\n                .addClass('message-content')\n                .text(text.substring(0, 10000));\n\n            // Add timestamp (current time)\n            const currentTimestamp = Math.floor(Date.now() / 1000);\n            const timestampDiv = $('<div>')\n                .addClass('message-timestamp')\n                .text(this.formatTimestamp(currentTimestamp));\n\n            messageEl.append(contentDiv);\n            messageEl.append(timestampDiv);\n\n            messages.append(messageEl);\n            this.scrollToBottom();\n        }\n\n        showTypingIndicator() {\n            const messages = this.root.find(SELECTORS.MESSAGES);\n            if (messages.find('.tutor-ia-typing').length) {\n                return;\n            }\n\n            const typing = $('<div class=\"tutor-ia-message ai tutor-ia-typing\"></div>')\n                .html('<span class=\"dot\"></span><span class=\"dot\"></span><span class=\"dot\"></span>');\n            messages.append(typing);\n            this.scrollToBottom();\n        }\n\n        hideTypingIndicator() {\n            this.root.find('.tutor-ia-typing').remove();\n        }\n\n        /**\n         * Show no credits warning in chat\n         * @param {string} errorHtml - HTML error message from provider\n         */\n        showNoCreditsWarning(errorHtml) {\n            const messages = this.root.find(SELECTORS.MESSAGES);\n\n            messages.find('.tutor-ia-no-credits-warning').remove();\n\n            const warningDiv = $('<div class=\"tutor-ia-no-credits-warning\"></div>');\n            const alertDiv = $('<div class=\"alert alert-danger\"></div>');\n            alertDiv.html(\n                '<i class=\"fa fa-exclamation-circle\"></i> ' +\n                '<div class=\"warning-content\">' +\n                '<strong>No Credits Available</strong>' +\n                '<p>' + errorHtml + '</p>' +\n                '</div>'\n            );\n\n            warningDiv.append(alertDiv);\n            messages.append(warningDiv);\n            this.scrollToBottom();\n        }\n\n        scrollToBottom() {\n            const messages = this.root.find(SELECTORS.MESSAGES);\n            messages.scrollTop(messages[0].scrollHeight);\n        }\n\n        closeCurrentStream() {\n            if (this.currentEventSource) {\n                try {\n                    this.currentEventSource.close();\n                } catch (e) {\n                    // Ignore.\n                }\n            }\n            this.currentEventSource = null;\n            this.streaming = false;\n            this.currentAIMessageEl = null;\n            this.currentAIMessageContainer = null;\n            this.hideTypingIndicator();\n        }\n\n        finalizeStream(sendBtn) {\n            if (this.currentAIMessageContainer) {\n                const currentTimestamp = Math.floor(Date.now() / 1000);\n                const timestampDiv = $('<div>')\n                    .addClass('message-timestamp')\n                    .text(this.formatTimestamp(currentTimestamp));\n                $(this.currentAIMessageContainer).append(timestampDiv);\n\n                this.currentAIMessageContainer = null;\n            }\n\n            this.closeCurrentStream();\n            if (sendBtn) {\n                sendBtn.prop('disabled', false);\n            }\n        }\n\n        sanitizeString(str) {\n            if (typeof str !== 'string') {\n                return '';\n            }\n            return str.replace(/[<>]/g, '');\n        }\n\n        /**\n         * Check if error is related to webservice configuration\n         * @param {Object} err - Error object\n         * @returns {boolean}\n         */\n        isWebserviceConfigError(err) {\n            if (!err || !err.message) {\n                return false;\n            }\n            const message = err.message.toLowerCase();\n            return message.includes('webservice_not_configured') ||\n                   message.includes('webservice not configured') ||\n                   message.includes('error_webservice_not_configured');\n        }\n\n        /**\n         * Check if error is related to insufficient AI credits\n         * @param {Object} err - Error object\n         * @returns {boolean}\n         */\n        isNoCreditsError(err) {\n            if (!err || !err.message) {\n                return false;\n            }\n            const message = err.message.toLowerCase();\n            return message.includes('notenoughtokens') ||\n                   message.includes('insufficient ai credits') ||\n                   message.includes('no credits') ||\n                   message.includes('out of credits');\n        }\n\n        /**\n         * Get friendly error message from exception\n         * @param {Object} err - Error object\n         * @returns {string} Friendly error message\n         */\n        getFriendlyErrorMessage(err) {\n            if (!err) {\n                return 'An unknown error occurred. Please try again.';\n            }\n\n            // Check if it's a webservice configuration error\n            if (this.isWebserviceConfigError(err)) {\n                // Return the error message as-is since it's already friendly\n                // (comes from our language strings)\n                return err.message || err.error || 'Configuration error';\n            }\n\n            // For other errors, provide generic friendly message\n            if (err.message) {\n                return err.message;\n            }\n\n            if (err.error) {\n                return err.error;\n            }\n\n            return 'An error occurred. Please try again later.';\n        }\n\n        /**\n         * Extract configuration URL from error message (for admin users)\n         * @param {Object} err - Error object\n         * @returns {string|null} Configuration URL or null\n         */\n        extractConfigUrl(err) {\n            if (!err || !err.message) {\n                return null;\n            }\n\n            // Try to extract URL from error message\n            // Format: <a href=\"URL\" target=\"_blank\">\n            const hrefMatch = err.message.match(/href=\"([^\"]+)\"/);\n            if (hrefMatch && hrefMatch[1]) {\n                return hrefMatch[1];\n            }\n\n            return null;\n        }\n\n        cleanup() {\n            this.closeCurrentStream();\n        }\n\n        destroy() {\n            this.cleanup();\n        }\n    }\n\n    return {\n        init: function(root, uniqueId, courseId, cmId, userId) {\n            return new TutorIAChat(root, uniqueId, courseId, cmId, userId);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","PubSub","ErrorModal","SELECTORS","TutorIAChat","constructor","root","uniqueId","courseId","cmId","userId","streaming","currentEventSource","currentSessionId","currentAIMessageEl","currentAIMessageContainer","selectedText","selectionLineCount","selectionCharCount","highlightedRange","historyOffset","historyLimit","isLoadingHistory","hasMoreHistory","historyLoaded","welcomeMessage","getAttribute","isConfigured","drawerElement","document","querySelector","pageElement","bodyElement","toggleButton","closeButton","jumpTo","position","this","pageClass","bodyClass","pageContext","detectPageContext","adjustDrawerTopPosition","init","navbarSelectors","navbarHeight","selector","navbar","offsetHeight","style","setProperty","window","addEventListener","newHeight","context","M","cfg","pagetype","bodyId","body","id","replace","pathMatch","className","match","urlParams","URLSearchParams","location","search","includes","has","discussionid","parseInt","get","forumid","attemptid","assignid","pageid","registerEventListeners","cleanup","e","preventDefault","toggleDrawer","closeDrawer","find","on","sendMessage","input","key","shiftKey","height","Math","min","scrollHeight","handleHistoryScroll","isDrawerOpen","subscribe","focus","handleTextSelection","ctrlKey","metaKey","clearSelection","getSelection","removeAllRanges","selection","toString","trim","length","removeHighlight","split","applyHighlight","updateSelectionIndicator","indicator","countElement","lineText","charText","text","show","hide","rangeCount","range","getRangeAt","highlightSpan","createElement","setAttribute","appendChild","extractContents","insertNode","console","warn","parent","parentNode","firstChild","insertBefore","removeChild","normalize","classList","contains","openDrawer","publish","add","loadChatHistory","remove","messagesContainer","scrollHeightBefore","scrollTopBefore","scrollTop","showHistoryLoading","call","methodname","args","courseid","limit","offset","then","data","hideHistoryLoading","success","messages","isInitialLoad","displayHistoryMessages","pagination","has_more","scrollToBottom","scrollDiff","catch","err","errorMessage","getFriendlyErrorMessage","isConfigError","isWebserviceConfigError","configUrl","extractConfigUrl","showConfigError","showGeneralError","i","messageDiv","createMessageElement","append","forEach","msg","prepend","addClass","role","attr","contentDiv","content","timestampDiv","formatTimestamp","timestamp","date","Date","today","messageDate","getFullYear","getMonth","getDate","todayDate","yesterday","setDate","hours","getHours","padStart","minutes","getMinutes","time","getTime","day","month","year","loadingDiv","sendBtn","messageText","val","addMessage","closeCurrentStream","prop","css","showTypingIndicator","metaData","user_role","floor","now","page","cmid","selected_text","message","sanitizeString","substring","meta","JSON","stringify","stream_url","Error","session_id","startSSE","hideTypingIndicator","isNoCreditsError","errorHtml","showNoCreditsWarning","error","streamUrl","es","EventSource","firstToken","messageCompleted","ev","payload","parse","t","ensureAIMessageEl","appendToAIMessage","finalizeStream","messageContainer","typingEl","removeClass","html","currentText","textContent","remaining","type","messageEl","currentTimestamp","typing","warningDiv","alertDiv","close","str","toLowerCase","hrefMatch","destroy"],"mappings":";;;;;;;AAuBAA,qCAAO,CACH,SACA,YACA,oBACA,cACA,8BACD,SACCC,EACAC,KACAC,aACAC,OACAC,kBAIMC,qBACU,kCADVA,iBAEM,mBAFNA,oBAGS,yBAHTA,mBAIQ,oCAJRA,gBAKK,iCALLA,mBAMQ,+BANRA,eAOI,QAPJA,kBAQO,WARPA,eASI,aAGJC,YACFC,YAAYC,KAAMC,SAAUC,SAAUC,KAAMC,aACnCJ,KAAOR,EAAEQ,WACTC,SAAWA,cACXC,SAAWA,cACXC,KAAOA,UACPC,OAASA,YACTC,WAAY,OACZC,mBAAqB,UACrBC,iBAAmB,UACnBC,mBAAqB,UACrBC,0BAA4B,UAG5BC,aAAe,QACfC,mBAAqB,OACrBC,mBAAqB,OACrBC,iBAAmB,UAGnBC,cAAgB,OAChBC,aAAe,QACfC,kBAAmB,OACnBC,gBAAiB,OACjBC,eAAgB,OAGhBC,eAAiBnB,KAAKoB,aAAa,wBAA0B,QAG7DC,aAA2D,MAA5CrB,KAAKoB,aAAa,uBAC0B,SAA5CpB,KAAKoB,aAAa,2BAEjCE,cAAgBC,SAASC,cAAc3B,uBACvC4B,YAAcF,SAASC,cAAc3B,qBACrC6B,YAAcH,SAASC,cAAc3B,qBACrC8B,aAAeJ,SAASC,cAAc3B,2BACtC+B,YAAcL,SAASC,cAAc3B,0BACrCgC,OAASN,SAASC,cAAc3B,wBAGhCiC,SAAWC,KAAKT,eAAgBS,KAAKT,cAAcF,aAAa,kBAA8B,aAC9FY,UAA8B,SAAlBD,KAAKD,SAAsB,mBAAqB,yBAE5DG,UAA8B,SAAlBF,KAAKD,SAAsB,4BAA8B,kCAGrEI,YAAcH,KAAKI,yBAGnBC,+BAEAC,OAQTD,8BACSL,KAAKT,2BAKJgB,gBAAkB,CACpB,oBACA,oBACA,yBACA,gBACA,yBAGAC,aAAe,OAEd,MAAMC,YAAYF,gBAAiB,OAC9BG,OAASlB,SAASC,cAAcgB,aAClCC,SAEAF,aAAeE,OAAOC,aAGlBH,aAAe,cAOtBjB,cAAcqB,MAAMC,YAAY,wBAAyBL,aAAe,MAG7EM,OAAOC,iBAAiB,UAAU,WACxBL,OAASlB,SAASC,cAAcc,gBAAgB,OAClDG,OAAQ,OACFM,UAAYN,OAAOC,kBACpBpB,cAAcqB,MAAMC,YAAY,wBAAyBG,UAAY,UAUtFZ,0BACUa,QAAU,MAGC,oBAANC,GAAqBA,EAAEC,KAAOD,EAAEC,IAAIC,WAC3CH,QAAQG,SAAWF,EAAEC,IAAIC,WAIxBH,QAAQG,SAAU,OACbC,OAAS7B,SAAS8B,KAAKC,GACzBF,SAGAJ,QAAQG,SAAWC,OAAOG,QAAQ,QAAS,SAK9CP,QAAQG,SAAU,OAGbK,UAFcjC,SAAS8B,KAAKI,UAEJC,MAAM,iBAChCF,YACAR,QAAQG,SAAWK,UAAU,UAK/BG,UAAY,IAAIC,gBAAgBf,OAAOgB,SAASC,eAGlDd,QAAQG,UAAYH,QAAQG,SAASY,SAAS,UAE1CJ,UAAUK,IAAI,OACdhB,QAAQiB,aAAeC,SAASP,UAAUQ,IAAI,KAAM,KAGpDR,UAAUK,IAAI,OACdhB,QAAQoB,QAAUF,SAASP,UAAUQ,IAAI,KAAM,MAE5CnB,QAAQG,UAAYH,QAAQG,SAASY,SAAS,QAEjDJ,UAAUK,IAAI,aACdhB,QAAQqB,UAAYH,SAASP,UAAUQ,IAAI,WAAY,KAEpDnB,QAAQG,UAAYH,QAAQG,SAASY,SAAS,UAEjDJ,UAAUK,IAAI,QACdhB,QAAQsB,SAAWJ,SAASP,UAAUQ,IAAI,MAAO,KAE9CnB,QAAQG,UAAYH,QAAQG,SAASY,SAAS,SAEjDJ,UAAUK,IAAI,YACdhB,QAAQuB,OAASL,SAASP,UAAUQ,IAAI,UAAW,KAIpDnB,QAGXX,YACSmC,yBACL3B,OAAOC,iBAAiB,gBAAgB,IAAMf,KAAK0C,YAGvDD,yBAEQzC,KAAKJ,mBACAA,aAAamB,iBAAiB,SAAU4B,IACzCA,EAAEC,sBACGC,kBAKT7C,KAAKH,kBACAA,YAAYkB,iBAAiB,SAAU4B,IACxCA,EAAEC,sBACGE,sBAKR7E,KAAK8E,KAAKjF,oBAAoBkF,GAAG,SAAS,UACtCC,uBAIHC,MAAQlD,KAAK/B,KAAK8E,KAAKjF,iBAC7BoF,MAAMF,GAAG,WAAYL,IACH,UAAVA,EAAEQ,KAAoBR,EAAES,WACxBT,EAAEC,sBACGK,kBAKbC,MAAMF,GAAG,SAAS,gBACTpC,MAAMyC,OAAS,YACfzC,MAAMyC,OAASC,KAAKC,IAAIvD,KAAKwD,aAAc,KAAO,QAIjCxD,KAAK/B,KAAK8E,KAAKjF,oBACvBkF,GAAG,UAAU,UACtBS,yBAITjE,SAASuB,iBAAiB,WAAY4B,IAC9B3C,KAAK0D,gBAA4B,WAAVf,EAAEQ,UACpBL,iBAKblF,OAAO+F,UAAU,6BAA6B,KACtC3D,KAAK0D,qBACAZ,iBAKT9C,KAAKF,aACAA,OAAOiB,iBAAiB,SAAS,KAC9Bf,KAAKH,kBACAA,YAAY+D,WAM7BpE,SAASuB,iBAAiB,WAAW,UAC5B8C,yBAITrE,SAASuB,iBAAiB,SAAU4B,KAC5BA,EAAES,UAAYT,EAAEmB,SAAWnB,EAAEoB,eACxBF,8BAKR5F,KAAK8E,KAAK,mCAAmCC,GAAG,SAAS,UACrDgB,iBAEDlD,OAAOmD,cACPnD,OAAOmD,eAAeC,qBAgBlCL,4BACUM,UAAYrD,OAAOmD,eACnBtF,aAAewF,UAAYA,UAAUC,WAAWC,OAAS,GAI3D1F,cAAgBA,aAAa2F,OAAS,SAEjCC,uBAGA5F,aAAeA,kBAGfC,mBAAqBD,aAAa6F,MAAM,MAAMF,YAG9CzF,mBAAqBF,aAAa2F,YAGlCG,eAAeN,gBAGfO,4BASbA,iCACUC,UAAY3E,KAAK/B,KAAK8E,KAAK,uCAC3B6B,aAAe5E,KAAK/B,KAAK8E,KAAK,sCAE/B4B,UAAUL,QAAWM,aAAaN,UAInCtE,KAAKrB,cAAgBqB,KAAKrB,aAAa2F,OAAS,GAAKtE,KAAKpB,mBAAqB,EAAG,OAE5EiG,SAAuC,IAA5B7E,KAAKpB,mBAA2B,OAAS,QACpDkG,SAAuC,IAA5B9E,KAAKnB,mBAA2B,OAAS,QAC1D+F,aAAaG,eAAQ/E,KAAKpB,+BAAsBiG,sBAAa7E,KAAKnB,+BAAsBiG,uBACxFH,UAAUK,YAGVL,UAAUM,OAOlBjB,sBACSrF,aAAe,QACfC,mBAAqB,OACrBC,mBAAqB,OAGrB0F,uBAGAG,2BASTD,eAAeN,cACNA,WAAsC,IAAzBA,UAAUe,qBAMlBC,MAAQhB,UAAUiB,WAAW,GAG7BC,cAAgB7F,SAAS8F,cAAc,QAC7CD,cAAc3D,UAAY,0BAC1B2D,cAAcE,aAAa,0BAA2B,QAItDF,cAAcG,YAAYL,MAAMM,mBAGhCN,MAAMO,WAAWL,oBAGZvG,iBAAmBuG,cAC1B,MAAO1C,GAEL7B,OAAO6E,QAAQC,KAAK,kCAAmCjD,IAQ/D4B,qBACSvE,KAAKlB,2BAMA+G,OAAS7F,KAAKlB,iBAAiBgH,cAEjCD,OAAQ,MAED7F,KAAKlB,iBAAiBiH,YACzBF,OAAOG,aAAahG,KAAKlB,iBAAiBiH,WAAY/F,KAAKlB,kBAI/D+G,OAAOI,YAAYjG,KAAKlB,kBAGxB+G,OAAOK,aAEb,MAAOvD,GAEL7B,OAAO6E,QAAQC,KAAK,mCAAoCjD,gBAGnD7D,iBAAmB,MAIhC4E,sBACW1D,KAAKT,eAAiBS,KAAKT,cAAc4G,UAAUC,SAAS,QAGvEC,aACSrG,KAAKT,gBAKV3B,OAAO0I,QAAQ,oBAAqB,SAE/B/G,cAAc4G,UAAUI,IAAI,aAC5BhH,cAAcgG,aAAa,WAAY,KAGxCvF,KAAKJ,mBACAA,aAAa2F,aAAa,gBAAiB,QAIhDvF,KAAKN,cAAgBM,KAAKN,YAAYyG,UAAUC,SAASpG,KAAKC,iBACzDP,YAAYyG,UAAUI,IAAIvG,KAAKC,WAIpCD,KAAKL,cAAgBK,KAAKL,YAAYwG,UAAUC,SAASpG,KAAKE,iBACzDP,YAAYwG,UAAUI,IAAIvG,KAAKE,WAIpCF,KAAKF,cACAA,OAAOyF,aAAa,WAAY,QAChCzF,OAAO8D,SAIZ5D,KAAKV,mBACAkH,mBAIb1D,cACS9C,KAAKT,qBAILA,cAAc4G,UAAUM,OAAO,aAC/BlH,cAAcgG,aAAa,WAAY,MAGxCvF,KAAKJ,mBACAA,aAAa2F,aAAa,gBAAiB,SAIhDvF,KAAKN,aAAeM,KAAKN,YAAYyG,UAAUC,SAASpG,KAAKC,iBACxDP,YAAYyG,UAAUM,OAAOzG,KAAKC,WAIvCD,KAAKL,aAAeK,KAAKL,YAAYwG,UAAUC,SAASpG,KAAKE,iBACxDP,YAAYwG,UAAUM,OAAOzG,KAAKE,WAIvCF,KAAKF,aACAA,OAAOyF,aAAa,YAAa,GAEtCvF,KAAKJ,mBACAA,aAAagE,SAI1Bf,eACQ7C,KAAK0D,oBACAZ,mBAEAuD,aAObG,qBAEQxG,KAAKf,mBAAqBe,KAAKd,2BAI9BD,kBAAmB,QAGlByH,kBAAoB1G,KAAK/B,KAAK8E,KAAKjF,oBACnC6I,mBAAqBD,kBAAkB,GAAGlD,aAC1CoD,gBAAkBF,kBAAkB,GAAGG,eAGxCC,qBAEYpJ,KAAKqJ,KAAK,CAAC,CACxBC,WAAY,iCACZC,KAAM,CACFC,SAAU/E,SAASnC,KAAK7B,SAAU,IAClCgJ,MAAOnH,KAAKhB,aACZoI,OAAQpH,KAAKjB,kBAIZ,GACJsI,MAAMC,eACEC,qBAEDD,KAAKE,SAAWF,KAAKG,UAAYH,KAAKG,SAASnD,OAAS,EAAG,OACrDoD,cAAuC,IAAvB1H,KAAKjB,sBAGtB4I,uBAAuBL,KAAKG,SAAUC,oBAGtC3I,eAAiBuI,KAAKG,SAASnD,YAC/BpF,eAAiBoI,KAAKM,WAAWC,SAElCH,mBAEKI,qBACF,OAGGC,WADoBrB,kBAAkB,GAAGlD,aACRmD,mBACvCD,kBAAkB,GAAGG,UAAYD,gBAAkBmB,sBAGlD7I,gBAAiB,cAGrBC,eAAgB,OAChBF,kBAAmB,EACjBqI,QAEVU,OAAOC,WACCV,0BACAtI,kBAAmB,QAGlBiJ,aAAelI,KAAKmI,wBAAwBF,KAC5CG,cAAgBpI,KAAKqI,wBAAwBJ,KAC7CK,UAAYtI,KAAKuI,iBAAiBN,KAEpCG,cACAvK,WAAW2K,gBAAgBN,aAAcI,WAEzCzK,WAAW4K,iBAAiBP,iBAQ5CzE,sBAC8BzD,KAAK/B,KAAK8E,KAAKjF,oBACL,GAAG+I,UAGvB,MAAQ7G,KAAKf,kBAAoBe,KAAKd,qBAC7CsH,kBASbmB,uBAAuBF,SAAUC,qBACvBhB,kBAAoB1G,KAAK/B,KAAK8E,KAAKjF,uBAGrC4J,eAAiB1H,KAAKZ,gBACtBsH,kBAAkB3D,KAAK,kCAAoC/C,KAAKZ,eAAiB,MAAMqH,SAGvFiB,kBAGK,IAAIgB,EAAIjB,SAASnD,OAAS,EAAGoE,GAAK,EAAGA,IAAK,OACrCC,WAAa3I,KAAK4I,qBAAqBnB,SAASiB,IACtDhC,kBAAkBmC,OAAOF,iBAK7BlB,SAASqB,SAAQC,YACPJ,WAAa3I,KAAK4I,qBAAqBG,KAC7CrC,kBAAkBsC,QAAQL,eAUtCC,qBAAqBG,WACXJ,WAAalL,EAAE,SAChBwL,SAAS,oBACTA,SAAsB,SAAbF,IAAIG,KAAkB,OAAS,MACxCC,KAAK,kBAAmBJ,IAAIxH,IAE3B6H,WAAa3L,EAAE,SAChBwL,SAAS,mBACTlE,KAAKgE,IAAIM,SAERC,aAAe7L,EAAE,SAClBwL,SAAS,qBACTlE,KAAK/E,KAAKuJ,gBAAgBR,IAAIS,mBAEnCb,WAAWE,OAAOO,YAClBT,WAAWE,OAAOS,cAEXX,WAQXY,gBAAgBC,iBACNC,KAAO,IAAIC,KAAiB,IAAZF,WAChBG,MAAQ,IAAID,KAGZE,YAAc,IAAIF,KAAKD,KAAKI,cAAeJ,KAAKK,WAAYL,KAAKM,WACjEC,UAAY,IAAIN,KAAKC,MAAME,cAAeF,MAAMG,WAAYH,MAAMI,WAClEE,UAAY,IAAIP,KAAKM,WAC3BC,UAAUC,QAAQD,UAAUF,UAAY,SAElCI,MAAQV,KAAKW,WAAWhG,WAAWiG,SAAS,EAAG,KAC/CC,QAAUb,KAAKc,aAAanG,WAAWiG,SAAS,EAAG,KACnDG,eAAUL,kBAASG,YAGrBV,YAAYa,YAAcT,UAAUS,iBAC7BD,QAIPZ,YAAYa,YAAcR,UAAUQ,oCAChBD,YAIlBE,IAAMjB,KAAKM,UAAU3F,WAAWiG,SAAS,EAAG,KAC5CM,OAASlB,KAAKK,WAAa,GAAG1F,WAAWiG,SAAS,EAAG,KACrDO,KAAOnB,KAAKI,8BACRa,gBAAOC,kBAASC,iBAAQJ,MAMtC1D,2BACUJ,kBAAoB1G,KAAK/B,KAAK8E,KAAKjF,wBACpC4I,kBAAkB3D,KAAK,oBAAoBuB,OAAQ,OAC9CuG,WAAapN,EAAE,SAChBwL,SAAS,mBACTlE,KAAK,cACV2B,kBAAkBsC,QAAQ6B,aAOlCtD,0BACStJ,KAAK8E,KAAK,oBAAoB0D,SAGvCxD,kBAESjD,KAAKV,0BAIJ4D,MAAQlD,KAAK/B,KAAK8E,KAAKjF,iBACvBgN,QAAU9K,KAAK/B,KAAK8E,KAAKjF,oBAEzBiN,YAAc7H,MAAM8H,MAAM3G,UAG3B0G,cAAe/K,KAAK1B,aAKL,MAAhByM,eAMAA,YAAYzG,OAAS,SAChB2G,WAAW,wDAAyD,oBAKpEC,qBACLJ,QAAQK,KAAK,YAAY,QAEpBF,WAAWF,YAAa,QAC7B7H,MAAM8H,IAAI,IACV9H,MAAMkI,IAAI,SAAU,aACftD,sBACAuD,4BAECC,SAAW,CACbC,UAAW,UACX/B,UAAWlG,KAAKkI,MAAM9B,KAAK+B,MAAQ,MAGnCzL,KAAKG,YAAYiB,WACjBkK,SAASI,KAAO1L,KAAKG,YAAYiB,UAGjCpB,KAAKG,YAAY+B,eACjBoJ,SAASpJ,aAAelC,KAAKG,YAAY+B,cAEzClC,KAAKG,YAAYkC,UACjBiJ,SAASjJ,QAAUrC,KAAKG,YAAYkC,SAEpCrC,KAAKG,YAAYmC,YACjBgJ,SAAShJ,UAAYtC,KAAKG,YAAYmC,WAEtCtC,KAAKG,YAAYoC,WACjB+I,SAAS/I,SAAWvC,KAAKG,YAAYoC,UAErCvC,KAAKG,YAAYqC,SACjB8I,SAAS9I,OAASxC,KAAKG,YAAYqC,QAEnCxC,KAAK5B,OACLkN,SAASK,KAAOxJ,SAASnC,KAAK5B,KAAM,KAIpC4B,KAAKrB,cAAgBqB,KAAKrB,aAAa2F,OAAS,IAChDgH,SAASM,cAAgB5L,KAAKrB,cAGjBjB,KAAKqJ,KAAK,CAAC,CACxBC,WAAY,oCACZC,KAAM,CACFC,SAAU/E,SAASnC,KAAK7B,SAAU,IAClC0N,QAAS7L,KAAK8L,eAAef,YAAYgB,UAAU,EAAG,MACtDC,KAAMC,KAAKC,UAAUZ,cAIpB,GACJjE,MAAMC,WACEA,OAASA,KAAK6E,iBACT,IAAIC,MAAM,8CAEf5N,iBAAmB8I,KAAK+E,gBACxBC,SAAShF,KAAK6E,WAAYrB,cAG1B9G,iBAEEsD,QAEVU,OAAOC,cACCsE,sBAEDvM,KAAKwM,iBAAiBvE,KAAM,OACtBwE,UAAYxE,IAAI4D,SAAW,0CAC5Ba,qBAAqBD,WAEZzM,KAAK/B,KAAK8E,KAAKjF,iBACvBqN,KAAK,YAAY,GACvBL,QAAQK,KAAK,YAAY,OACtB,CACHL,QAAQK,KAAK,YAAY,SAEnBjD,aAAelI,KAAKmI,wBAAwBF,KAC5CG,cAAgBpI,KAAKqI,wBAAwBJ,KAC7CK,UAAYtI,KAAKuI,iBAAiBN,KAEpCG,cACAvK,WAAW2K,gBAAgBN,aAAcI,WAEzCzK,WAAW4K,iBAAiBP,kBAI9C,MAAOyE,YACAJ,sBACLzB,QAAQK,KAAK,YAAY,GACzBtN,WAAW4K,iBAAiB,mBAAqBkE,MAAMd,mBAtGlDZ,WAAW,wCAAyC,MA0GjEqB,SAASM,UAAW9B,mBAEN+B,GAAK,IAAIC,YAAYF,gBACtBrO,mBAAqBsO,QACrBvO,WAAY,MACbyO,YAAa,EACbC,kBAAmB,EAEvBH,GAAG9L,iBAAiB,SAAUkM,eAEhBC,QAAUjB,KAAKkB,MAAMF,GAAG3F,MACxBvC,KAAOmI,QAAQE,GAAKF,QAAQ7D,SAAW,GAEzC0D,aACAA,YAAa,OACRM,yBACAd,4BAEJe,kBAAkBvI,MACzB,MAAOpC,QAMbkK,GAAG9L,iBAAiB,QAAQ,KACxBiM,kBAAmB,OACdO,eAAezC,YAIxB+B,GAAG9L,iBAAiB,qBAAqB,KACrCiM,kBAAmB,OACdO,eAAezC,YAGxB+B,GAAG9L,iBAAiB,SAAS,KAEpBiM,wBACIM,kBAAkB,mCAClBC,eAAezC,aAI9B,MAAO6B,YACA1B,WAAW,6CAA8C,WACzDsC,eAAezC,UAI5BuC,uBACQrN,KAAKvB,0BACEuB,KAAKvB,yBAGVgJ,SAAWzH,KAAK/B,KAAK8E,KAAKjF,wBAC5B0P,uBAGEC,SAAWhG,SAAS1E,KAAK,oBAC3B0K,SAASnJ,QAETkJ,iBAAmBC,SACnBD,iBAAiBE,YAAY,mBAC7BF,iBAAiBvE,SAAS,uBAC1BuE,iBAAiBG,KAAK,MAGtBH,iBAAmB/P,EAAE,2CACrBgK,SAASoB,OAAO2E,yBAIdpE,WAAa3L,EAAE,SAChBwL,SAAS,0BACduE,iBAAiB3E,OAAOO,iBAGnB3K,mBAAqB2K,WAAW,QAChC1K,0BAA4B8O,iBAAiB,GAC3CxN,KAAKvB,mBAGhB6O,kBAAkBvI,SACT/E,KAAKvB,yBACD4O,qBAEJrN,KAAKvB,oBAAsC,iBAATsG,kBAIjC6I,YAAc5N,KAAKvB,mBAAmBoP,aAAe,MAGvDD,YAAYtJ,OAASS,KAAKT,OAFZ,WAGRwJ,UAHQ,IAGgBF,YAAYtJ,OACtCwJ,UAAY,SACPrP,mBAAmBoP,aAAe9I,KAAKgH,UAAU,EAAG+B,WAAa,iBAKzErP,mBAAmBoP,aAAe9I,UAClC+C,iBAGTmD,WAAWlG,KAAMgJ,UACRhJ,MAAwB,iBAATA,kBAId0C,SAAWzH,KAAK/B,KAAK8E,KAAKjF,oBAG1BkQ,UAAYvQ,EAAE,eACfwL,SAAS,oBACTA,SAAS8E,MAGR3E,WAAa3L,EAAE,SAChBwL,SAAS,mBACTlE,KAAKA,KAAKgH,UAAU,EAAG,MAGtBkC,iBAAmB3K,KAAKkI,MAAM9B,KAAK+B,MAAQ,KAC3CnC,aAAe7L,EAAE,SAClBwL,SAAS,qBACTlE,KAAK/E,KAAKuJ,gBAAgB0E,mBAE/BD,UAAUnF,OAAOO,YACjB4E,UAAUnF,OAAOS,cAEjB7B,SAASoB,OAAOmF,gBACXlG,iBAGTuD,4BACU5D,SAAWzH,KAAK/B,KAAK8E,KAAKjF,uBAC5B2J,SAAS1E,KAAK,oBAAoBuB,oBAIhC4J,OAASzQ,EAAE,2DACZkQ,KAAK,+EACVlG,SAASoB,OAAOqF,aACXpG,iBAGTyE,2BACStO,KAAK8E,KAAK,oBAAoB0D,SAOvCiG,qBAAqBD,iBACXhF,SAAWzH,KAAK/B,KAAK8E,KAAKjF,oBAEhC2J,SAAS1E,KAAK,gCAAgC0D,eAExC0H,WAAa1Q,EAAE,mDACf2Q,SAAW3Q,EAAE,0CACnB2Q,SAAST,KACL,iHAGQlB,UAHR,cAOJ0B,WAAWtF,OAAOuF,UAClB3G,SAASoB,OAAOsF,iBACXrG,iBAGTA,uBACUL,SAAWzH,KAAK/B,KAAK8E,KAAKjF,oBAChC2J,SAASZ,UAAUY,SAAS,GAAGjE,cAGnC0H,wBACQlL,KAAKzB,4BAEIA,mBAAmB8P,QAC1B,MAAO1L,SAIRpE,mBAAqB,UACrBD,WAAY,OACZG,mBAAqB,UACrBC,0BAA4B,UAC5B6N,sBAGTgB,eAAezC,YACP9K,KAAKtB,0BAA2B,OAC1BuP,iBAAmB3K,KAAKkI,MAAM9B,KAAK+B,MAAQ,KAC3CnC,aAAe7L,EAAE,SAClBwL,SAAS,qBACTlE,KAAK/E,KAAKuJ,gBAAgB0E,mBAC/BxQ,EAAEuC,KAAKtB,2BAA2BmK,OAAOS,mBAEpC5K,0BAA4B,UAGhCwM,qBACDJ,SACAA,QAAQK,KAAK,YAAY,GAIjCW,eAAewC,WACQ,iBAARA,IACA,GAEJA,IAAI9M,QAAQ,QAAS,IAQhC6G,wBAAwBJ,SACfA,MAAQA,IAAI4D,eACN,QAELA,QAAU5D,IAAI4D,QAAQ0C,qBACrB1C,QAAQ7J,SAAS,8BACjB6J,QAAQ7J,SAAS,8BACjB6J,QAAQ7J,SAAS,mCAQ5BwK,iBAAiBvE,SACRA,MAAQA,IAAI4D,eACN,QAELA,QAAU5D,IAAI4D,QAAQ0C,qBACrB1C,QAAQ7J,SAAS,oBACjB6J,QAAQ7J,SAAS,4BACjB6J,QAAQ7J,SAAS,eACjB6J,QAAQ7J,SAAS,kBAQ5BmG,wBAAwBF,YACfA,IAKDjI,KAAKqI,wBAAwBJ,KAGtBA,IAAI4D,SAAW5D,IAAI0E,OAAS,sBAInC1E,IAAI4D,QACG5D,IAAI4D,QAGX5D,IAAI0E,MACG1E,IAAI0E,MAGR,6CAnBI,+CA2BfpE,iBAAiBN,SACRA,MAAQA,IAAI4D,eACN,WAKL2C,UAAYvG,IAAI4D,QAAQlK,MAAM,yBAChC6M,WAAaA,UAAU,GAChBA,UAAU,GAGd,KAGX9L,eACSwI,qBAGTuD,eACS/L,iBAIN,CACHpC,KAAM,SAASrC,KAAMC,SAAUC,SAAUC,KAAMC,eACpC,IAAIN,YAAYE,KAAMC,SAAUC,SAAUC,KAAMC"}