{"version":3,"file":"tutor_ia_chat.min.js","sources":["../src/tutor_ia_chat.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tutor-IA Chat - Drawer and chat functionality (based on aiplacement_courseassist)\n *\n * @module     local_dttutor/tutor_ia_chat\n * @copyright  2025 Datacurso\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'core/pubsub',\n    'core/str',\n    'local_dttutor/error_modal'\n], function(\n    $,\n    Ajax,\n    Notification,\n    PubSub,\n    Str,\n    ErrorModal\n) {\n    'use strict';\n\n    const SELECTORS = {\n        TOGGLE_BTN: '[data-action=\"tutor-ia-toggle\"]',\n        DRAWER: '.tutor-ia-drawer',\n        CLOSE_BTN: '.tutor-ia-close-button',\n        MESSAGES: '[data-region=\"tutor-ia-messages\"]',\n        INPUT: '[data-region=\"tutor-ia-input\"]',\n        SEND_BTN: '[data-action=\"send-message\"]',\n        PAGE: '#page',\n        JUMP_TO: '#jump-to',\n        BODY: 'body'\n    };\n\n    /**\n     * TutorIAChat - Main chat drawer and messaging functionality.\n     *\n     * @class TutorIAChat\n     */\n    class TutorIAChat {\n        /**\n         * Constructor.\n         *\n         * @param {HTMLElement} root - The root element for the chat\n         * @param {string} uniqueId - Unique identifier for the instance\n         * @param {number} courseId - Course ID\n         * @param {number} cmId - Course module ID\n         * @param {number} userId - User ID\n         */\n        constructor(root, uniqueId, courseId, cmId, userId) {\n            this.root = $(root);\n            this.uniqueId = uniqueId;\n            this.courseId = courseId;\n            this.cmId = cmId;\n            this.userId = userId;\n            this.streaming = false;\n            this.currentEventSource = null;\n            this.currentSessionId = null;\n            this.currentAIMessageEl = null;\n            this.currentAIMessageContainer = null;\n\n            // Text selection state.\n            this.selectedText = '';\n            this.selectionLineCount = 0;\n            this.selectionCharCount = 0;\n\n            // Bound functions for proper event listener removal.\n            this.boundHandleTextSelectionMouseUp = null;\n            this.boundHandleTextSelectionKeyUp = null;\n            this.textSelectionListenersActive = false;\n            this.textSelectionDebounceTimer = null;\n\n            // Cached DOM elements for performance.\n            this.cachedSelectionIndicator = null;\n            this.cachedSelectionCount = null;\n\n            // History pagination state.\n            this.historyOffset = 0;\n            this.historyLimit = 20;\n            this.isLoadingHistory = false;\n            this.hasMoreHistory = true;\n            this.historyLoaded = false;\n\n            // Language strings (loaded asynchronously).\n            this.strings = {};\n            this.stringsLoaded = false;\n\n            this.welcomeMessage = root.getAttribute('data-welcomemessage') || '';\n            this.isConfigured = root.getAttribute('data-is-configured') === '1' ||\n                                root.getAttribute('data-is-configured') === 'true';\n\n            this.drawerElement = document.querySelector(SELECTORS.DRAWER);\n            this.pageElement = document.querySelector(SELECTORS.PAGE);\n            this.bodyElement = document.querySelector(SELECTORS.BODY);\n            this.toggleButton = document.querySelector(SELECTORS.TOGGLE_BTN);\n            this.closeButton = document.querySelector(SELECTORS.CLOSE_BTN);\n            this.jumpTo = document.querySelector(SELECTORS.JUMP_TO);\n\n            this.position = this.drawerElement ? this.drawerElement.getAttribute('data-position') || 'right' : 'right';\n            this.pageClass = this.position === 'left' ? 'show-drawer-left' : 'show-drawer-right';\n            // Used for footer-popover positioning via CSS.\n            this.bodyClass = this.position === 'left' ? 'tutor-ia-drawer-open-left' : 'tutor-ia-drawer-open-right';\n\n            this.pageContext = this.detectPageContext();\n            this.adjustDrawerTopPosition();\n            this.init();\n        }\n\n        /**\n         * Adjusts the drawer top position based on the navbar height.\n         * Ensures compatibility with different Moodle themes that may have different navbar heights.\n         */\n        adjustDrawerTopPosition() {\n            if (!this.drawerElement) {\n                return;\n            }\n\n            const navbarSelectors = [\n                '.navbar.fixed-top',\n                '.fixed-top.navbar',\n                '#page-header.fixed-top',\n                'nav.fixed-top',\n                '.navbar-fixed-top'\n            ];\n\n            let navbarHeight = 60;\n\n            for (const selector of navbarSelectors) {\n                const navbar = document.querySelector(selector);\n                if (navbar) {\n                    navbarHeight = navbar.offsetHeight;\n                    if (navbarHeight > 0) {\n                        break;\n                    }\n                }\n            }\n\n            this.drawerElement.style.setProperty('--tutor-ia-drawer-top', navbarHeight + 'px');\n\n            window.addEventListener('resize', () => {\n                const navbar = document.querySelector(navbarSelectors[0]);\n                if (navbar) {\n                    const newHeight = navbar.offsetHeight;\n                    this.drawerElement.style.setProperty('--tutor-ia-drawer-top', newHeight + 'px');\n                }\n            });\n        }\n\n        /**\n         * Detects the current page context (page type and relevant parameters).\n         *\n         * @returns {Object} Object with page contextual information\n         */\n        detectPageContext() {\n            const context = {};\n\n            if (typeof M !== 'undefined' && M.cfg && M.cfg.pagetype) {\n                context.pagetype = M.cfg.pagetype;\n            }\n\n            // Fallback: extract from body id (format: \"page-mod-forum-discuss\").\n            if (!context.pagetype) {\n                const bodyId = document.body.id;\n                if (bodyId) {\n                    context.pagetype = bodyId.replace('page-', '');\n                }\n            }\n\n            // Fallback: extract from body classes.\n            if (!context.pagetype) {\n                const bodyClasses = document.body.className;\n                const pathMatch = bodyClasses.match(/path-([\\w-]+)/);\n                if (pathMatch) {\n                    context.pagetype = pathMatch[1];\n                }\n            }\n\n            const urlParams = new URLSearchParams(window.location.search);\n\n            if (context.pagetype && context.pagetype.includes('forum')) {\n                if (urlParams.has('d')) {\n                    context.discussionid = parseInt(urlParams.get('d'), 10);\n                }\n                if (urlParams.has('f')) {\n                    context.forumid = parseInt(urlParams.get('f'), 10);\n                }\n            } else if (context.pagetype && context.pagetype.includes('quiz')) {\n                if (urlParams.has('attempt')) {\n                    context.attemptid = parseInt(urlParams.get('attempt'), 10);\n                }\n            } else if (context.pagetype && context.pagetype.includes('assign')) {\n                if (urlParams.has('id')) {\n                    context.assignid = parseInt(urlParams.get('id'), 10);\n                }\n            } else if (context.pagetype && context.pagetype.includes('wiki')) {\n                if (urlParams.has('pageid')) {\n                    context.pageid = parseInt(urlParams.get('pageid'), 10);\n                }\n            }\n\n            return context;\n        }\n\n        init() {\n            this.loadStrings();\n            this.registerEventListeners();\n            window.addEventListener('beforeunload', () => this.cleanup());\n        }\n\n        /**\n         * Load language strings asynchronously.\n         */\n        loadStrings() {\n            Str.get_strings([\n                {key: 'line', component: 'local_dttutor'},\n                {key: 'lines', component: 'local_dttutor'},\n                {key: 'char', component: 'local_dttutor'},\n                {key: 'chars', component: 'local_dttutor'},\n                {key: 'selected', component: 'local_dttutor'},\n                {key: 'yesterday', component: 'local_dttutor'},\n                {key: 'loading', component: 'local_dttutor'},\n                {key: 'error_invalid_message', component: 'local_dttutor'},\n                {key: 'error_message_too_long', component: 'local_dttutor'},\n                {key: 'error_no_credits', component: 'local_dttutor'},\n                {key: 'error_no_credits_short', component: 'local_dttutor'},\n                {key: 'error_internal', component: 'local_dttutor'},\n                {key: 'connection_interrupted', component: 'local_dttutor'},\n                {key: 'error_establish_sse_connection', component: 'local_dttutor'},\n                {key: 'error_unexpected', component: 'local_dttutor'},\n                {key: 'error_unknown', component: 'local_dttutor'},\n                {key: 'configuration_error', component: 'local_dttutor'},\n                {key: 'error_attempt_later', component: 'local_dttutor'},\n                {key: 'error_license_fallback', component: 'local_dttutor'},\n                {key: 'error_license_fallback_short', component: 'local_dttutor'},\n                {key: 'error_no_credits_fallback', component: 'local_dttutor'},\n                {key: 'error_insufficient_tokens_short', component: 'local_dttutor'}\n            ]).then((strings) => {\n                this.strings = {\n                    line: strings[0],\n                    lines: strings[1],\n                    char: strings[2],\n                    chars: strings[3],\n                    selected: strings[4],\n                    yesterday: strings[5],\n                    loading: strings[6],\n                    errorInvalidMessage: strings[7],\n                    errorMessageTooLong: strings[8],\n                    errorNoCredits: strings[9],\n                    errorNoCreditsShort: strings[10],\n                    errorInternal: strings[11],\n                    connectionInterrupted: strings[12],\n                    errorEstablishSse: strings[13],\n                    errorUnexpected: strings[14],\n                    errorUnknown: strings[15],\n                    configurationError: strings[16],\n                    errorAttemptLater: strings[17],\n                    errorLicenseFallback: strings[18],\n                    errorLicenseFallbackShort: strings[19],\n                    errorNoCreditssFallback: strings[20],\n                    errorInsufficientTokensShort: strings[21]\n                };\n                this.stringsLoaded = true;\n                return;\n            }).catch(() => {\n                // Fallback to English if strings fail to load.\n                this.strings = {\n                    line: 'line',\n                    lines: 'lines',\n                    char: 'char',\n                    chars: 'chars',\n                    selected: 'selected',\n                    yesterday: 'Yesterday',\n                    loading: 'Loading...',\n                    errorInvalidMessage: 'Please enter a valid message',\n                    errorMessageTooLong: '[Error] Message is too long. Maximum 4000 characters.',\n                    errorNoCredits: 'Insufficient AI credits available.',\n                    errorNoCreditsShort: 'No Credits Available',\n                    errorInternal: 'Internal error: {$a}',\n                    connectionInterrupted: '[Connection interrupted]',\n                    errorEstablishSse: '[Error] Could not establish SSE connection',\n                    errorUnexpected: 'An unexpected error occurred. Please try again.',\n                    errorUnknown: 'An unknown error occurred. Please try again.',\n                    configurationError: 'Configuration error',\n                    errorAttemptLater: 'An error occurred. Please try again later.',\n                    errorLicenseFallback: 'License error: {$a}',\n                    errorLicenseFallbackShort: 'License Error',\n                    errorNoCreditssFallback: 'Insufficient credits: {$a}',\n                    errorInsufficientTokensShort: 'Insufficient Credits'\n                };\n                this.stringsLoaded = true;\n            });\n        }\n\n        /**\n         * Register all event listeners for the chat functionality.\n         */\n        registerEventListeners() {\n            if (this.toggleButton) {\n                this.toggleButton.addEventListener('click', (e) => {\n                    e.preventDefault();\n                    this.toggleDrawer();\n                });\n            }\n\n            if (this.closeButton) {\n                this.closeButton.addEventListener('click', (e) => {\n                    e.preventDefault();\n                    this.closeDrawer();\n                });\n            }\n\n            this.root.find(SELECTORS.SEND_BTN).on('click', () => {\n                this.sendMessage();\n            });\n\n            const input = this.root.find(SELECTORS.INPUT);\n            input.on('keydown', (e) => {\n                if (e.key === 'Enter' && !e.shiftKey) {\n                    e.preventDefault();\n                    this.sendMessage();\n                }\n            });\n\n            input.on('input', function() {\n                this.style.height = 'auto';\n                this.style.height = Math.min(this.scrollHeight, 120) + 'px';\n            });\n\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n            messagesContainer.on('scroll', () => {\n                this.handleHistoryScroll();\n            });\n\n            document.addEventListener('keydown', (e) => {\n                if (this.isDrawerOpen() && e.key === 'Escape') {\n                    this.closeDrawer();\n                }\n            });\n\n            // Close drawer if Moodle's message drawer opens (prevent conflict).\n            PubSub.subscribe('core_message/drawer_shown', () => {\n                if (this.isDrawerOpen()) {\n                    this.closeDrawer();\n                }\n            });\n\n            if (this.jumpTo) {\n                this.jumpTo.addEventListener('focus', () => {\n                    if (this.closeButton) {\n                        this.closeButton.focus();\n                    }\n                });\n            }\n\n            // Text selection listeners are dynamically added/removed when drawer opens/closes.\n            this.root.find('[data-action=\"clear-selection\"]').on('click', () => {\n                this.clearSelection();\n                if (window.getSelection) {\n                    window.getSelection().removeAllRanges();\n                }\n            });\n        }\n\n        /**\n         * Attaches text selection event listeners to the document.\n         * Called when the drawer opens. Uses debouncing to prevent excessive processing.\n         */\n        attachTextSelectionListeners() {\n            if (this.textSelectionListenersActive) {\n                return;\n            }\n\n            this.boundHandleTextSelectionMouseUp = () => {\n                this.debouncedHandleTextSelection();\n            };\n\n            this.boundHandleTextSelectionKeyUp = (e) => {\n                if (e.shiftKey || e.ctrlKey || e.metaKey) {\n                    this.debouncedHandleTextSelection();\n                }\n            };\n\n            document.addEventListener('mouseup', this.boundHandleTextSelectionMouseUp);\n            document.addEventListener('keyup', this.boundHandleTextSelectionKeyUp);\n\n            this.textSelectionListenersActive = true;\n        }\n\n        /**\n         * Detaches text selection event listeners from the document.\n         * Called when the drawer closes to eliminate performance overhead.\n         */\n        detachTextSelectionListeners() {\n            if (!this.textSelectionListenersActive) {\n                return;\n            }\n\n            if (this.boundHandleTextSelectionMouseUp) {\n                document.removeEventListener('mouseup', this.boundHandleTextSelectionMouseUp);\n                this.boundHandleTextSelectionMouseUp = null;\n            }\n\n            if (this.boundHandleTextSelectionKeyUp) {\n                document.removeEventListener('keyup', this.boundHandleTextSelectionKeyUp);\n                this.boundHandleTextSelectionKeyUp = null;\n            }\n\n            if (this.textSelectionDebounceTimer) {\n                clearTimeout(this.textSelectionDebounceTimer);\n                this.textSelectionDebounceTimer = null;\n            }\n\n            this.textSelectionListenersActive = false;\n        }\n\n        /**\n         * Debounced version of handleTextSelection.\n         * Waits 150ms before processing to prevent excessive DOM operations.\n         */\n        debouncedHandleTextSelection() {\n            if (this.textSelectionDebounceTimer) {\n                clearTimeout(this.textSelectionDebounceTimer);\n            }\n\n            this.textSelectionDebounceTimer = setTimeout(() => {\n                this.handleTextSelection();\n                this.textSelectionDebounceTimer = null;\n            }, 150);\n        }\n\n        /**\n         * Handles text selection on the page.\n         * IMPORTANT: This method ONLY reads the selection - it does NOT modify the page DOM.\n         * Selection persists until explicitly cleared by user action (X button, send message, or new selection).\n         */\n        handleTextSelection() {\n            const selection = window.getSelection();\n            const selectedText = selection ? selection.toString().trim() : '';\n\n            // Only update if there is actual new text selected.\n            if (selectedText && selectedText.length > 0) {\n                this.selectedText = selectedText;\n                this.selectionLineCount = selectedText.split('\\n').length;\n                this.selectionCharCount = selectedText.length;\n                this.updateSelectionIndicator();\n            }\n        }\n\n        /**\n         * Caches selection indicator DOM elements for performance.\n         */\n        cacheSelectionIndicatorElements() {\n            this.cachedSelectionIndicator = this.root.find('[data-region=\"selection-indicator\"]');\n            this.cachedSelectionCount = this.root.find('[data-region=\"selection-count\"]');\n        }\n\n        /**\n         * Updates the selection indicator in the chat UI.\n         */\n        updateSelectionIndicator() {\n            const indicator = this.cachedSelectionIndicator || this.root.find('[data-region=\"selection-indicator\"]');\n            const countElement = this.cachedSelectionCount || this.root.find('[data-region=\"selection-count\"]');\n\n            if (!indicator.length || !countElement.length) {\n                return;\n            }\n\n            if (this.selectedText && this.selectedText.length > 0 && this.selectionLineCount > 0) {\n                const lineText = this.selectionLineCount === 1 ? this.strings.line : this.strings.lines;\n                const charText = this.selectionCharCount === 1 ? this.strings.char : this.strings.chars;\n                const selectionText = this.selectionLineCount + ' ' + lineText + ', ' +\n                    this.selectionCharCount + ' ' + charText + ' ' + this.strings.selected;\n                countElement.text(selectionText);\n                indicator.show();\n            } else {\n                indicator.hide();\n            }\n        }\n\n        /**\n         * Clears the text selection state.\n         */\n        clearSelection() {\n            this.selectedText = '';\n            this.selectionLineCount = 0;\n            this.selectionCharCount = 0;\n            this.updateSelectionIndicator();\n        }\n\n        /**\n         * Check if the drawer is currently open.\n         *\n         * @returns {boolean} True if drawer is open\n         */\n        isDrawerOpen() {\n            return this.drawerElement && this.drawerElement.classList.contains('show');\n        }\n\n        /**\n         * Opens the chat drawer.\n         */\n        openDrawer() {\n            if (!this.drawerElement) {\n                return;\n            }\n\n            // Close Moodle's message drawer to prevent conflict.\n            PubSub.publish('core_message/hide', {});\n\n            this.drawerElement.classList.add('show');\n            this.drawerElement.setAttribute('tabindex', '0');\n\n            if (this.toggleButton) {\n                this.toggleButton.setAttribute('aria-expanded', 'true');\n            }\n\n            if (this.pageElement && !this.pageElement.classList.contains(this.pageClass)) {\n                this.pageElement.classList.add(this.pageClass);\n            }\n\n            if (this.bodyElement && !this.bodyElement.classList.contains(this.bodyClass)) {\n                this.bodyElement.classList.add(this.bodyClass);\n            }\n\n            if (this.jumpTo) {\n                this.jumpTo.setAttribute('tabindex', 0);\n                this.jumpTo.focus();\n            }\n\n            if (this.isConfigured) {\n                this.loadChatHistory();\n            }\n\n            this.attachTextSelectionListeners();\n            this.cacheSelectionIndicatorElements();\n        }\n\n        /**\n         * Closes the chat drawer.\n         */\n        closeDrawer() {\n            if (!this.drawerElement) {\n                return;\n            }\n\n            this.drawerElement.classList.remove('show');\n            this.drawerElement.setAttribute('tabindex', '-1');\n\n            if (this.toggleButton) {\n                this.toggleButton.setAttribute('aria-expanded', 'false');\n            }\n\n            if (this.pageElement && this.pageElement.classList.contains(this.pageClass)) {\n                this.pageElement.classList.remove(this.pageClass);\n            }\n\n            if (this.bodyElement && this.bodyElement.classList.contains(this.bodyClass)) {\n                this.bodyElement.classList.remove(this.bodyClass);\n            }\n\n            if (this.jumpTo) {\n                this.jumpTo.setAttribute('tabindex', -1);\n            }\n            if (this.toggleButton) {\n                this.toggleButton.focus();\n            }\n\n            this.detachTextSelectionListeners();\n        }\n\n        /**\n         * Toggles the drawer open/closed state.\n         */\n        toggleDrawer() {\n            if (this.isDrawerOpen()) {\n                this.closeDrawer();\n            } else {\n                this.openDrawer();\n            }\n        }\n\n        /**\n         * Load chat history from API.\n         */\n        loadChatHistory() {\n            if (this.isLoadingHistory || !this.hasMoreHistory) {\n                return;\n            }\n\n            this.isLoadingHistory = true;\n\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n            const scrollHeightBefore = messagesContainer[0].scrollHeight;\n            const scrollTopBefore = messagesContainer[0].scrollTop;\n\n            this.showHistoryLoading();\n\n            const requests = Ajax.call([{\n                methodname: \"local_dttutor_get_chat_history\",\n                args: {\n                    courseid: parseInt(this.courseId, 10),\n                    limit: this.historyLimit,\n                    offset: this.historyOffset\n                },\n            }]);\n\n            requests[0]\n                .then((data) => {\n                    this.hideHistoryLoading();\n\n                    if (data.success && data.messages && data.messages.length > 0) {\n                        const isInitialLoad = this.historyOffset === 0;\n\n                        this.displayHistoryMessages(data.messages, isInitialLoad);\n                        this.historyOffset += data.messages.length;\n                        this.hasMoreHistory = data.pagination.has_more;\n\n                        if (isInitialLoad) {\n                            this.scrollToBottom();\n                        } else {\n                            // Maintain scroll position when loading older messages.\n                            const scrollHeightAfter = messagesContainer[0].scrollHeight;\n                            const scrollDiff = scrollHeightAfter - scrollHeightBefore;\n                            messagesContainer[0].scrollTop = scrollTopBefore + scrollDiff;\n                        }\n                    } else {\n                        this.hasMoreHistory = false;\n                    }\n\n                    this.historyLoaded = true;\n                    this.isLoadingHistory = false;\n                    return data;\n                })\n                .catch((err) => {\n                    this.hideHistoryLoading();\n                    this.isLoadingHistory = false;\n\n                    const errorMessage = this.getFriendlyErrorMessage(err);\n                    const isConfigError = this.isWebserviceConfigError(err);\n                    const configUrl = this.extractConfigUrl(err);\n\n                    if (isConfigError) {\n                        ErrorModal.showConfigError(errorMessage, configUrl);\n                    } else {\n                        ErrorModal.showGeneralError(errorMessage);\n                    }\n                });\n        }\n\n        /**\n         * Handle scroll event for infinity scroll.\n         */\n        handleHistoryScroll() {\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n            const scrollTop = messagesContainer[0].scrollTop;\n\n            if (scrollTop < 100 && !this.isLoadingHistory && this.hasMoreHistory) {\n                this.loadChatHistory();\n            }\n        }\n\n        /**\n         * Display history messages in the chat.\n         *\n         * @param {Array} messages - Array of message objects (ordered DESC by timestamp from backend)\n         * @param {boolean} isInitialLoad - True if first load (append), false for older messages (prepend)\n         */\n        displayHistoryMessages(messages, isInitialLoad) {\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n\n            if (isInitialLoad && this.welcomeMessage) {\n                messagesContainer.find('.tutor-ia-message.ai:contains(\"' + this.welcomeMessage + '\")').remove();\n            }\n\n            if (isInitialLoad) {\n                // Initial load: reverse to get chronological order.\n                for (let i = messages.length - 1; i >= 0; i--) {\n                    const messageDiv = this.createMessageElement(messages[i]);\n                    messagesContainer.append(messageDiv);\n                }\n            } else {\n                // Loading older: prepend to place above existing messages.\n                messages.forEach(msg => {\n                    const messageDiv = this.createMessageElement(msg);\n                    messagesContainer.prepend(messageDiv);\n                });\n            }\n        }\n\n        /**\n         * Create a message element.\n         *\n         * @param {Object} msg - Message object\n         * @returns {jQuery} Message element\n         */\n        createMessageElement(msg) {\n            const messageDiv = $('<div>')\n                .addClass('tutor-ia-message')\n                .addClass(msg.role === 'user' ? 'user' : 'ai')\n                .attr('data-message-id', msg.id);\n\n            const contentDiv = $('<div>')\n                .addClass('message-content')\n                .text(msg.content);\n\n            const timestampDiv = $('<div>')\n                .addClass('message-timestamp')\n                .text(this.formatTimestamp(msg.timestamp));\n\n            messageDiv.append(contentDiv);\n            messageDiv.append(timestampDiv);\n\n            return messageDiv;\n        }\n\n        /**\n         * Format Unix timestamp to readable date and time.\n         *\n         * @param {number} timestamp - Unix timestamp\n         * @returns {string} Formatted date and time string\n         */\n        formatTimestamp(timestamp) {\n            const date = new Date(timestamp * 1000);\n            const today = new Date();\n\n            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());\n            const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());\n            const yesterday = new Date(todayDate);\n            yesterday.setDate(yesterday.getDate() - 1);\n\n            const hours = date.getHours().toString().padStart(2, '0');\n            const minutes = date.getMinutes().toString().padStart(2, '0');\n            const time = `${hours}:${minutes}`;\n\n            if (messageDate.getTime() === todayDate.getTime()) {\n                return time;\n            }\n\n            if (messageDate.getTime() === yesterday.getTime()) {\n                return `${this.strings.yesterday} ${time}`;\n            }\n\n            const day = date.getDate().toString().padStart(2, '0');\n            const month = (date.getMonth() + 1).toString().padStart(2, '0');\n            const year = date.getFullYear();\n            return `${day}/${month}/${year} ${time}`;\n        }\n\n        /**\n         * Show loading indicator at top of messages.\n         */\n        showHistoryLoading() {\n            const messagesContainer = this.root.find(SELECTORS.MESSAGES);\n            if (!messagesContainer.find('.history-loading').length) {\n                const loadingDiv = $('<div>')\n                    .addClass('history-loading')\n                    .text(this.strings.loading);\n                messagesContainer.prepend(loadingDiv);\n            }\n        }\n\n        /**\n         * Hide loading indicator.\n         */\n        hideHistoryLoading() {\n            this.root.find('.history-loading').remove();\n        }\n\n        /**\n         * Send a message to the AI tutor.\n         */\n        sendMessage() {\n            if (!this.isConfigured) {\n                return;\n            }\n\n            const input = this.root.find(SELECTORS.INPUT);\n            const sendBtn = this.root.find(SELECTORS.SEND_BTN);\n            const messageText = input.val().trim();\n\n            if (!messageText || this.streaming) {\n                return;\n            }\n\n            if (messageText === '.') {\n                this.addMessage('[Error] ' + this.strings.errorInvalidMessage, 'ai');\n                return;\n            }\n\n            if (messageText.length > 4000) {\n                this.addMessage(this.strings.errorMessageTooLong, 'ai');\n                return;\n            }\n\n            try {\n                this.closeCurrentStream();\n                sendBtn.prop('disabled', true);\n\n                this.addMessage(messageText, 'user');\n                input.val('');\n                input.css('height', 'auto');\n                this.scrollToBottom();\n                this.showTypingIndicator();\n\n                const metaData = {\n                    user_role: 'Student',\n                    timestamp: Math.floor(Date.now() / 1000)\n                };\n\n                if (this.pageContext.pagetype) {\n                    metaData.page = this.pageContext.pagetype;\n                }\n                if (this.pageContext.discussionid) {\n                    metaData.discussionid = this.pageContext.discussionid;\n                }\n                if (this.pageContext.forumid) {\n                    metaData.forumid = this.pageContext.forumid;\n                }\n                if (this.pageContext.attemptid) {\n                    metaData.attemptid = this.pageContext.attemptid;\n                }\n                if (this.pageContext.assignid) {\n                    metaData.assignid = this.pageContext.assignid;\n                }\n                if (this.pageContext.pageid) {\n                    metaData.pageid = this.pageContext.pageid;\n                }\n                if (this.cmId) {\n                    metaData.cmid = parseInt(this.cmId, 10);\n                }\n                if (this.selectedText && this.selectedText.length > 0) {\n                    metaData.selected_text = this.selectedText;\n                }\n\n                const forceReindexCheckbox = this.root.find('[data-region=\"debug-force-reindex\"]');\n                if (forceReindexCheckbox.length && forceReindexCheckbox.is(':checked')) {\n                    metaData.force_reindex = true;\n                }\n\n                const requests = Ajax.call([{\n                    methodname: \"local_dttutor_create_chat_message\",\n                    args: {\n                        courseid: parseInt(this.courseId, 10),\n                        message: this.sanitizeString(messageText.substring(0, 4000)),\n                        meta: JSON.stringify(metaData)\n                    },\n                }]);\n\n                requests[0]\n                    .then((data) => {\n                        if (!data || !data.stream_url) {\n                            throw new Error('Stream URL missing in response');\n                        }\n                        this.currentSessionId = data.session_id;\n                        this.startSSE(data.stream_url, sendBtn);\n                        this.clearSelection();\n\n                        return data;\n                    })\n                    .catch((err) => {\n                        this.hideTypingIndicator();\n\n                        if (this.isNoCreditsError(err)) {\n                            const errorHtml = err.message || this.strings.errorNoCredits;\n                            this.showNoCreditsWarning(errorHtml);\n\n                            const inputEl = this.root.find(SELECTORS.INPUT);\n                            inputEl.prop('disabled', true);\n                            sendBtn.prop('disabled', true);\n                        } else {\n                            sendBtn.prop('disabled', false);\n\n                            const errorMessage = this.getFriendlyErrorMessage(err);\n                            const isConfigError = this.isWebserviceConfigError(err);\n                            const configUrl = this.extractConfigUrl(err);\n\n                            if (isConfigError) {\n                                ErrorModal.showConfigError(errorMessage, configUrl);\n                            } else {\n                                ErrorModal.showGeneralError(errorMessage);\n                            }\n                        }\n                    });\n            } catch (error) {\n                this.hideTypingIndicator();\n                sendBtn.prop('disabled', false);\n                ErrorModal.showGeneralError(this.strings.errorInternal.replace('{$a}', error.message));\n            }\n        }\n\n        /**\n         * Start Server-Sent Events stream for AI response.\n         *\n         * @param {string} streamUrl - URL for the SSE stream\n         * @param {jQuery} sendBtn - Send button element to re-enable on completion\n         */\n        startSSE(streamUrl, sendBtn) {\n            try {\n                const es = new EventSource(streamUrl);\n                this.currentEventSource = es;\n                this.streaming = true;\n                let firstToken = true;\n                let messageCompleted = false;\n\n                es.addEventListener('token', (ev) => {\n                    try {\n                        const payload = JSON.parse(ev.data);\n                        const text = payload.t || payload.content || '';\n\n                        if (firstToken) {\n                            firstToken = false;\n                            this.ensureAIMessageEl();\n                            this.hideTypingIndicator();\n                        }\n                        this.appendToAIMessage(text);\n                    } catch (e) {\n                        // Invalid token data, skip.\n                    }\n                });\n\n                es.addEventListener('done', () => {\n                    messageCompleted = true;\n                    this.finalizeStream(sendBtn);\n                });\n\n                // Backward compatibility with 'message_completed' event.\n                es.addEventListener('message_completed', () => {\n                    messageCompleted = true;\n                    this.finalizeStream(sendBtn);\n                });\n\n                es.addEventListener('error', (ev) => {\n                    if (ev.data) {\n                        try {\n                            const errorData = JSON.parse(ev.data);\n                            this.handleStreamError(errorData, sendBtn);\n                            return;\n                        } catch (e) {\n                            // Not JSON, continue with generic error handling.\n                        }\n                    }\n\n                    // Only show error if message did NOT complete (error after 'done' is expected).\n                    if (!messageCompleted) {\n                        this.appendToAIMessage('\\n' + this.strings.connectionInterrupted);\n                        this.finalizeStream(sendBtn);\n                    }\n                });\n            } catch (error) {\n                this.addMessage(this.strings.errorEstablishSse, 'ai');\n                this.finalizeStream(sendBtn);\n            }\n        }\n\n        /**\n         * Ensures an AI message element exists for streaming content.\n         *\n         * @returns {HTMLElement} The message content element\n         */\n        ensureAIMessageEl() {\n            if (this.currentAIMessageEl) {\n                return this.currentAIMessageEl;\n            }\n\n            const messages = this.root.find(SELECTORS.MESSAGES);\n            let messageContainer;\n\n            const typingEl = messages.find('.tutor-ia-typing');\n            if (typingEl.length) {\n                messageContainer = typingEl;\n                messageContainer.removeClass('tutor-ia-typing');\n                messageContainer.addClass('tutor-ia-message ai');\n                messageContainer.html('');\n            } else {\n                messageContainer = $('<div class=\"tutor-ia-message ai\"></div>');\n                messages.append(messageContainer);\n            }\n\n            const contentDiv = $('<div>')\n                .addClass('message-content');\n            messageContainer.append(contentDiv);\n\n            this.currentAIMessageEl = contentDiv[0];\n            this.currentAIMessageContainer = messageContainer[0];\n            return this.currentAIMessageEl;\n        }\n\n        /**\n         * Appends text to the current AI message element.\n         *\n         * @param {string} text - Text to append\n         */\n        appendToAIMessage(text) {\n            if (!this.currentAIMessageEl) {\n                this.ensureAIMessageEl();\n            }\n            if (!this.currentAIMessageEl || typeof text !== 'string') {\n                return;\n            }\n\n            const currentText = this.currentAIMessageEl.textContent || '';\n            const maxLength = 10000;\n\n            if (currentText.length + text.length > maxLength) {\n                const remaining = maxLength - currentText.length;\n                if (remaining > 0) {\n                    this.currentAIMessageEl.textContent += text.substring(0, remaining) + '...';\n                }\n                return;\n            }\n\n            this.currentAIMessageEl.textContent += text;\n            this.scrollToBottom();\n        }\n\n        /**\n         * Adds a complete message to the chat.\n         *\n         * @param {string} text - Message text\n         * @param {string} type - Message type ('user' or 'ai')\n         */\n        addMessage(text, type) {\n            if (!text || typeof text !== 'string') {\n                return;\n            }\n\n            const messages = this.root.find(SELECTORS.MESSAGES);\n\n            const messageEl = $('<div></div>')\n                .addClass('tutor-ia-message')\n                .addClass(type);\n\n            const contentDiv = $('<div>')\n                .addClass('message-content')\n                .text(text.substring(0, 10000));\n\n            const currentTimestamp = Math.floor(Date.now() / 1000);\n            const timestampDiv = $('<div>')\n                .addClass('message-timestamp')\n                .text(this.formatTimestamp(currentTimestamp));\n\n            messageEl.append(contentDiv);\n            messageEl.append(timestampDiv);\n\n            messages.append(messageEl);\n            this.scrollToBottom();\n        }\n\n        /**\n         * Shows the typing indicator.\n         */\n        showTypingIndicator() {\n            const messages = this.root.find(SELECTORS.MESSAGES);\n            if (messages.find('.tutor-ia-typing').length) {\n                return;\n            }\n\n            const typing = $('<div class=\"tutor-ia-message ai tutor-ia-typing\"></div>')\n                .html('<span class=\"dot\"></span><span class=\"dot\"></span><span class=\"dot\"></span>');\n            messages.append(typing);\n            this.scrollToBottom();\n        }\n\n        /**\n         * Hides the typing indicator.\n         */\n        hideTypingIndicator() {\n            this.root.find('.tutor-ia-typing').remove();\n        }\n\n        /**\n         * Show no credits warning in chat.\n         *\n         * @param {string} errorHtml - HTML error message from provider\n         */\n        showNoCreditsWarning(errorHtml) {\n            const messages = this.root.find(SELECTORS.MESSAGES);\n\n            messages.find('.tutor-ia-no-credits-warning').remove();\n\n            const warningDiv = $('<div class=\"tutor-ia-no-credits-warning\"></div>');\n            const alertDiv = $('<div class=\"alert alert-danger\"></div>');\n            alertDiv.html(\n                '<i class=\"fa fa-exclamation-circle\"></i> ' +\n                '<div class=\"warning-content\">' +\n                '<strong>' + this.strings.errorNoCreditsShort + '</strong>' +\n                '<p>' + errorHtml + '</p>' +\n                '</div>'\n            );\n\n            warningDiv.append(alertDiv);\n            messages.append(warningDiv);\n            this.scrollToBottom();\n        }\n\n        /**\n         * Scrolls the messages container to the bottom.\n         */\n        scrollToBottom() {\n            const messages = this.root.find(SELECTORS.MESSAGES);\n            messages.scrollTop(messages[0].scrollHeight);\n        }\n\n        /**\n         * Closes the current SSE stream.\n         */\n        closeCurrentStream() {\n            if (this.currentEventSource) {\n                try {\n                    this.currentEventSource.close();\n                } catch (e) {\n                    // Ignore close errors.\n                }\n            }\n            this.currentEventSource = null;\n            this.streaming = false;\n            this.currentAIMessageEl = null;\n            this.currentAIMessageContainer = null;\n            this.hideTypingIndicator();\n        }\n\n        /**\n         * Finalizes the stream and re-enables the send button.\n         *\n         * @param {jQuery} sendBtn - Send button element\n         */\n        finalizeStream(sendBtn) {\n            if (this.currentAIMessageContainer) {\n                const currentTimestamp = Math.floor(Date.now() / 1000);\n                const timestampDiv = $('<div>')\n                    .addClass('message-timestamp')\n                    .text(this.formatTimestamp(currentTimestamp));\n                $(this.currentAIMessageContainer).append(timestampDiv);\n\n                this.currentAIMessageContainer = null;\n            }\n\n            this.closeCurrentStream();\n            if (sendBtn) {\n                sendBtn.prop('disabled', false);\n            }\n        }\n\n        /**\n         * Handle structured error data from SSE stream.\n         * Detects license and insufficient tokens errors and shows user-friendly modals.\n         *\n         * @param {Object} errorData - Error data object from SSE event\n         * @param {jQuery} sendBtn - Send button element to re-enable\n         */\n        handleStreamError(errorData, sendBtn) {\n            this.hideTypingIndicator();\n            this.finalizeStream(sendBtn);\n\n            if (errorData && errorData.detail && errorData.detail.status === 'error') {\n                const errorMessage = errorData.detail.detail || '';\n\n                if (errorMessage.toLowerCase().includes('license not allowed')) {\n                    var self = this;\n                    Str.get_strings([\n                        {key: 'error_license_not_allowed', component: 'local_dttutor'},\n                        {key: 'error_license_not_allowed_short', component: 'local_dttutor'}\n                    ]).then(function(strings) {\n                        ErrorModal.showGeneralError(strings[0], strings[1]);\n                        return;\n                    }).catch(function() {\n                        ErrorModal.showGeneralError(\n                            self.strings.errorLicenseFallback.replace('{$a}', errorMessage),\n                            self.strings.errorLicenseFallbackShort\n                        );\n                    });\n                    return;\n                }\n\n                if (errorMessage.toLowerCase().includes('insufficient tokens')) {\n                    var selfTokens = this;\n                    Str.get_strings([\n                        {key: 'error_insufficient_tokens', component: 'local_dttutor'},\n                        {key: 'error_insufficient_tokens_short', component: 'local_dttutor'}\n                    ]).then(function(strings) {\n                        ErrorModal.showGeneralError(strings[0], strings[1]);\n                        return;\n                    }).catch(function() {\n                        ErrorModal.showGeneralError(\n                            selfTokens.strings.errorNoCreditssFallback.replace('{$a}', errorMessage),\n                            selfTokens.strings.errorInsufficientTokensShort\n                        );\n                    });\n                    return;\n                }\n\n                ErrorModal.showGeneralError(errorMessage);\n            } else {\n                ErrorModal.showGeneralError(this.strings.errorUnexpected);\n            }\n        }\n\n        /**\n         * Sanitizes a string by removing angle brackets.\n         *\n         * @param {string} str - String to sanitize\n         * @returns {string} Sanitized string\n         */\n        sanitizeString(str) {\n            if (typeof str !== 'string') {\n                return '';\n            }\n            return str.replace(/[<>]/g, '');\n        }\n\n        /**\n         * Check if error is related to webservice configuration.\n         *\n         * @param {Object} err - Error object\n         * @returns {boolean} True if webservice config error\n         */\n        isWebserviceConfigError(err) {\n            if (!err || !err.message) {\n                return false;\n            }\n            const message = err.message.toLowerCase();\n            return message.includes('webservice_not_configured') ||\n                   message.includes('webservice not configured') ||\n                   message.includes('error_webservice_not_configured');\n        }\n\n        /**\n         * Check if error is related to insufficient AI credits.\n         *\n         * @param {Object} err - Error object\n         * @returns {boolean} True if no credits error\n         */\n        isNoCreditsError(err) {\n            if (!err || !err.message) {\n                return false;\n            }\n            const message = err.message.toLowerCase();\n            return message.includes('notenoughtokens') ||\n                   message.includes('insufficient ai credits') ||\n                   message.includes('no credits') ||\n                   message.includes('out of credits');\n        }\n\n        /**\n         * Get friendly error message from exception.\n         *\n         * @param {Object} err - Error object\n         * @returns {string} Friendly error message\n         */\n        getFriendlyErrorMessage(err) {\n            if (!err) {\n                return this.strings.errorUnknown;\n            }\n\n            if (this.isWebserviceConfigError(err)) {\n                return err.message || err.error || this.strings.configurationError;\n            }\n\n            if (err.message) {\n                return err.message;\n            }\n\n            if (err.error) {\n                return err.error;\n            }\n\n            return this.strings.errorAttemptLater;\n        }\n\n        /**\n         * Extract configuration URL from error message (for admin users).\n         *\n         * @param {Object} err - Error object\n         * @returns {string|null} Configuration URL or null\n         */\n        extractConfigUrl(err) {\n            if (!err || !err.message) {\n                return null;\n            }\n\n            const hrefMatch = err.message.match(/href=\"([^\"]+)\"/);\n            if (hrefMatch && hrefMatch[1]) {\n                return hrefMatch[1];\n            }\n\n            return null;\n        }\n\n        /**\n         * Cleanup resources on page unload.\n         */\n        cleanup() {\n            this.closeCurrentStream();\n            this.detachTextSelectionListeners();\n        }\n\n        /**\n         * Destroys the chat instance and releases all resources.\n         */\n        destroy() {\n            this.cleanup();\n            this.cachedSelectionIndicator = null;\n            this.cachedSelectionCount = null;\n        }\n    }\n\n    return {\n        init: function(root, uniqueId, courseId, cmId, userId) {\n            return new TutorIAChat(root, uniqueId, courseId, cmId, userId);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","PubSub","Str","ErrorModal","SELECTORS","TutorIAChat","constructor","root","uniqueId","courseId","cmId","userId","streaming","currentEventSource","currentSessionId","currentAIMessageEl","currentAIMessageContainer","selectedText","selectionLineCount","selectionCharCount","boundHandleTextSelectionMouseUp","boundHandleTextSelectionKeyUp","textSelectionListenersActive","textSelectionDebounceTimer","cachedSelectionIndicator","cachedSelectionCount","historyOffset","historyLimit","isLoadingHistory","hasMoreHistory","historyLoaded","strings","stringsLoaded","welcomeMessage","getAttribute","isConfigured","drawerElement","document","querySelector","pageElement","bodyElement","toggleButton","closeButton","jumpTo","position","this","pageClass","bodyClass","pageContext","detectPageContext","adjustDrawerTopPosition","init","navbarSelectors","navbarHeight","selector","navbar","offsetHeight","style","setProperty","window","addEventListener","newHeight","context","M","cfg","pagetype","bodyId","body","id","replace","pathMatch","className","match","urlParams","URLSearchParams","location","search","includes","has","discussionid","parseInt","get","forumid","attemptid","assignid","pageid","loadStrings","registerEventListeners","cleanup","get_strings","key","component","then","line","lines","char","chars","selected","yesterday","loading","errorInvalidMessage","errorMessageTooLong","errorNoCredits","errorNoCreditsShort","errorInternal","connectionInterrupted","errorEstablishSse","errorUnexpected","errorUnknown","configurationError","errorAttemptLater","errorLicenseFallback","errorLicenseFallbackShort","errorNoCreditssFallback","errorInsufficientTokensShort","catch","e","preventDefault","toggleDrawer","closeDrawer","find","on","sendMessage","input","shiftKey","height","Math","min","scrollHeight","handleHistoryScroll","isDrawerOpen","subscribe","focus","clearSelection","getSelection","removeAllRanges","attachTextSelectionListeners","debouncedHandleTextSelection","ctrlKey","metaKey","detachTextSelectionListeners","removeEventListener","clearTimeout","setTimeout","handleTextSelection","selection","toString","trim","length","split","updateSelectionIndicator","cacheSelectionIndicatorElements","indicator","countElement","lineText","charText","selectionText","text","show","hide","classList","contains","openDrawer","publish","add","setAttribute","loadChatHistory","remove","messagesContainer","scrollHeightBefore","scrollTopBefore","scrollTop","showHistoryLoading","call","methodname","args","courseid","limit","offset","data","hideHistoryLoading","success","messages","isInitialLoad","displayHistoryMessages","pagination","has_more","scrollToBottom","scrollDiff","err","errorMessage","getFriendlyErrorMessage","isConfigError","isWebserviceConfigError","configUrl","extractConfigUrl","showConfigError","showGeneralError","i","messageDiv","createMessageElement","append","forEach","msg","prepend","addClass","role","attr","contentDiv","content","timestampDiv","formatTimestamp","timestamp","date","Date","today","messageDate","getFullYear","getMonth","getDate","todayDate","setDate","hours","getHours","padStart","minutes","getMinutes","time","getTime","day","month","year","loadingDiv","sendBtn","messageText","val","addMessage","closeCurrentStream","prop","css","showTypingIndicator","metaData","user_role","floor","now","page","cmid","selected_text","forceReindexCheckbox","is","force_reindex","message","sanitizeString","substring","meta","JSON","stringify","stream_url","Error","session_id","startSSE","hideTypingIndicator","isNoCreditsError","errorHtml","showNoCreditsWarning","error","streamUrl","es","EventSource","firstToken","messageCompleted","ev","payload","parse","t","ensureAIMessageEl","appendToAIMessage","finalizeStream","errorData","handleStreamError","messageContainer","typingEl","removeClass","html","currentText","textContent","remaining","type","messageEl","currentTimestamp","typing","warningDiv","alertDiv","close","detail","status","toLowerCase","self","selfTokens","str","hrefMatch","destroy"],"mappings":"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"}