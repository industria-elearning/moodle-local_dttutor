{"version":3,"file":"ai_modal.min.js","sources":["../src/ai_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AI Mode - Fullscreen modal chat functionality\n *\n * @module     local_dttutor/ai_modal\n * @copyright  2025 Industria Elearning\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/notification'\n], function(\n    $,\n    Ajax,\n    Notification\n) {\n    'use strict';\n\n    const SELECTORS = {\n        MODAL_TRIGGER: '[data-action=\"open-ai-modal\"]',\n        MODAL: '[data-region=\"ai-modal\"]',\n        CLOSE_BTN: '[data-action=\"close-ai-modal\"]',\n        INPUT: '[data-region=\"ai-modal-input\"]',\n        SEND_BTN: '[data-action=\"send-ai-message\"]',\n        MESSAGES_CONTAINER: '[data-region=\"ai-modal-messages\"]',\n        MESSAGES_SCROLL: '.ai-modal-messages-scroll',\n        QUICK_OPTIONS: '[data-action=\"quick-option\"]',\n        QUICK_OPTIONS_CONTAINER: '[data-region=\"quick-options\"]',\n        WELCOME: '.ai-modal-welcome'\n    };\n\n    class AIModal {\n        constructor() {\n            this.modal = null;\n            this.streaming = false;\n            this.currentEventSource = null;\n            this.currentSessionId = null;\n            this.conversationStarted = false;\n            this.courseId = null;\n            this.cmId = null;\n            this.userId = null;\n\n            this.init();\n        }\n\n        init() {\n            this.registerEventListeners();\n        }\n\n        registerEventListeners() {\n            // Open modal button.\n            $(document).on('click', SELECTORS.MODAL_TRIGGER, (e) => {\n                e.preventDefault();\n                this.openModal();\n            });\n\n            // Close modal button.\n            $(document).on('click', SELECTORS.CLOSE_BTN, (e) => {\n                e.preventDefault();\n                this.closeModal();\n            });\n\n            // Send button.\n            $(document).on('click', SELECTORS.SEND_BTN, () => {\n                this.sendMessage();\n            });\n\n            // Input - Enter to send.\n            $(document).on('keydown', SELECTORS.INPUT, (e) => {\n                if (e.key === 'Enter' && !e.shiftKey) {\n                    e.preventDefault();\n                    this.sendMessage();\n                }\n            });\n\n            // Auto-resize textarea.\n            $(document).on('input', SELECTORS.INPUT, function() {\n                this.style.height = 'auto';\n                this.style.height = Math.min(this.scrollHeight, 120) + 'px';\n            });\n\n            // Quick options.\n            $(document).on('click', SELECTORS.QUICK_OPTIONS, (e) => {\n                e.preventDefault();\n                const prompt = $(e.currentTarget).data('prompt');\n                this.handleQuickOption(prompt);\n            });\n\n            // Prevent closing on backdrop click.\n            $(document).on('click', SELECTORS.MODAL, (e) => {\n                if ($(e.target).is(SELECTORS.MODAL)) {\n                    e.stopPropagation();\n                    // Do not close - modal only closes via X button.\n                }\n            });\n\n            // Prevent ESC key from closing.\n            $(document).on('keydown', (e) => {\n                if (e.key === 'Escape' && this.isModalOpen()) {\n                    e.preventDefault();\n                    e.stopPropagation();\n                    // Do not close - modal only closes via X button.\n                }\n            });\n\n            // Cleanup on page unload.\n            $(window).on('beforeunload', () => this.cleanup());\n        }\n\n        isModalOpen() {\n            return this.modal && this.modal.is(':visible');\n        }\n\n        openModal() {\n            if (!this.modal) {\n                this.modal = $(SELECTORS.MODAL);\n            }\n\n            if (!this.modal.length) {\n                window.console.error('AI Modal not found in DOM');\n                return;\n            }\n\n            // Get context data from modal attributes.\n            this.courseId = this.modal.data('courseid');\n            this.cmId = this.modal.data('cmid') || 0;\n            this.userId = this.modal.data('userid');\n\n            // Show modal.\n            this.modal.fadeIn(300);\n            $('body').addClass('ai-modal-open');\n\n            // Focus input.\n            setTimeout(() => {\n                this.modal.find(SELECTORS.INPUT).focus();\n            }, 350);\n        }\n\n        closeModal() {\n            if (!this.modal) {\n                return;\n            }\n\n            // Close any active stream.\n            this.closeCurrentStream();\n\n            // Hide modal.\n            this.modal.fadeOut(300);\n            $('body').removeClass('ai-modal-open');\n\n            // Reset state.\n            this.conversationStarted = false;\n            this.currentSessionId = null;\n\n            // Clear messages.\n            this.modal.find(SELECTORS.MESSAGES_SCROLL).empty();\n\n            // Hide messages container, show welcome.\n            this.modal.find(SELECTORS.MESSAGES_CONTAINER).hide();\n            this.modal.find(SELECTORS.WELCOME).show();\n            this.modal.find(SELECTORS.QUICK_OPTIONS_CONTAINER).show();\n\n            // Clear input.\n            this.modal.find(SELECTORS.INPUT).val('').css('height', 'auto');\n        }\n\n        handleQuickOption(prompt) {\n            if (!prompt || this.streaming) {\n                return;\n            }\n\n            // Pre-fill input with prompt.\n            this.modal.find(SELECTORS.INPUT).val(prompt).focus();\n\n            // Auto-resize textarea.\n            const input = this.modal.find(SELECTORS.INPUT)[0];\n            input.style.height = 'auto';\n            input.style.height = Math.min(input.scrollHeight, 120) + 'px';\n        }\n\n        sendMessage() {\n            const input = this.modal.find(SELECTORS.INPUT);\n            const sendBtn = this.modal.find(SELECTORS.SEND_BTN);\n\n            const messageText = input.val().trim();\n            if (!messageText || this.streaming) {\n                return;\n            }\n\n            if (messageText.length > 4000) {\n                this.addMessage('[Error] Message is too long. Maximum 4000 characters.', 'ai');\n                return;\n            }\n\n            try {\n                this.closeCurrentStream();\n                sendBtn.prop('disabled', true);\n\n                // Start conversation mode.\n                if (!this.conversationStarted) {\n                    this.startConversation();\n                }\n\n                this.addMessage(messageText, 'user');\n                input.val('');\n                input.css('height', 'auto');\n                this.scrollToBottom();\n                this.showTypingIndicator();\n\n                // Build metadata.\n                const metaData = {\n                    user_role: 'User',\n                    timestamp: Math.floor(Date.now() / 1000),\n                    source: 'ai_modal'\n                };\n\n                if (this.cmId && this.cmId > 0) {\n                    metaData.cmid = parseInt(this.cmId, 10);\n                }\n\n                // Detect page context.\n                const pageContext = this.detectPageContext();\n                if (pageContext.pagetype) {\n                    metaData.page = pageContext.pagetype;\n                }\n\n                window.console.log('AI Modal sending metadata:', metaData);\n\n                const requests = Ajax.call([{\n                    methodname: \"local_dttutor_create_chat_message\",\n                    args: {\n                        courseid: parseInt(this.courseId, 10),\n                        message: this.sanitizeString(messageText.substring(0, 4000)),\n                        meta: JSON.stringify(metaData)\n                    },\n                }]);\n\n                requests[0]\n                    .then((data) => {\n                        if (!data || !data.stream_url) {\n                            throw new Error('Stream URL missing in response');\n                        }\n                        this.currentSessionId = data.session_id;\n                        this.startSSE(data.stream_url, sendBtn);\n                        return data;\n                    })\n                    .catch((err) => {\n                        this.hideTypingIndicator();\n                        this.addMessage('[Error] ' + (err.message || 'Unknown error'), 'ai');\n                        sendBtn.prop('disabled', false);\n                        Notification.exception(err);\n                    });\n            } catch (error) {\n                this.hideTypingIndicator();\n                this.addMessage('[Error] Internal error: ' + error.message, 'ai');\n                sendBtn.prop('disabled', false);\n            }\n        }\n\n        startConversation() {\n            // Hide welcome and quick options.\n            this.modal.find(SELECTORS.WELCOME).hide();\n            this.modal.find(SELECTORS.QUICK_OPTIONS_CONTAINER).hide();\n\n            // Show messages container.\n            this.modal.find(SELECTORS.MESSAGES_CONTAINER).show();\n\n            this.conversationStarted = true;\n        }\n\n        startSSE(streamUrl, sendBtn) {\n            try {\n                const es = new EventSource(streamUrl);\n                this.currentEventSource = es;\n                this.streaming = true;\n                let firstToken = true;\n                let messageCompleted = false;\n                let currentMessageEl = null;\n\n                es.addEventListener('token', (ev) => {\n                    try {\n                        const payload = JSON.parse(ev.data);\n                        const text = payload.t || payload.content || '';\n\n                        if (firstToken) {\n                            firstToken = false;\n                            currentMessageEl = this.createAIMessage();\n                            this.hideTypingIndicator();\n                        }\n                        this.appendToMessage(currentMessageEl, text);\n                    } catch (e) {\n                        window.console.warn('Invalid token data:', ev.data);\n                    }\n                });\n\n                es.addEventListener('done', () => {\n                    messageCompleted = true;\n                    this.finalizeStream(sendBtn);\n                });\n\n                es.addEventListener('message_completed', () => {\n                    messageCompleted = true;\n                    this.finalizeStream(sendBtn);\n                });\n\n                es.addEventListener('error', () => {\n                    if (!messageCompleted) {\n                        window.console.error('SSE error');\n                        if (currentMessageEl) {\n                            this.appendToMessage(currentMessageEl, '\\n[Connection interrupted]');\n                        }\n                        this.finalizeStream(sendBtn);\n                    }\n                });\n            } catch (error) {\n                window.console.error('Error starting SSE:', error);\n                this.addMessage('[Error] Could not establish SSE connection', 'ai');\n                this.finalizeStream(sendBtn);\n            }\n        }\n\n        createAIMessage() {\n            const messagesScroll = this.modal.find(SELECTORS.MESSAGES_SCROLL);\n            const messageEl = $('<div class=\"tutor-ia-message ai\"></div>');\n            messagesScroll.append(messageEl);\n            this.scrollToBottom();\n            return messageEl[0];\n        }\n\n        appendToMessage(messageEl, text) {\n            if (!messageEl || typeof text !== 'string') {\n                return;\n            }\n\n            const currentText = messageEl.textContent || '';\n            const maxLength = 10000;\n\n            if (currentText.length + text.length > maxLength) {\n                const remaining = maxLength - currentText.length;\n                if (remaining > 0) {\n                    messageEl.textContent += text.substring(0, remaining) + '...';\n                }\n                return;\n            }\n\n            messageEl.textContent += text;\n            this.scrollToBottom();\n        }\n\n        addMessage(text, type) {\n            if (!text || typeof text !== 'string') {\n                return;\n            }\n\n            const messagesScroll = this.modal.find(SELECTORS.MESSAGES_SCROLL);\n            const messageEl = $('<div></div>')\n                .addClass('tutor-ia-message')\n                .addClass(type)\n                .text(text.substring(0, 10000));\n\n            messagesScroll.append(messageEl);\n            this.scrollToBottom();\n        }\n\n        showTypingIndicator() {\n            const messagesScroll = this.modal.find(SELECTORS.MESSAGES_SCROLL);\n            if (messagesScroll.find('.tutor-ia-typing').length) {\n                return;\n            }\n\n            const typing = $('<div class=\"tutor-ia-message ai tutor-ia-typing\"></div>')\n                .html('<span class=\"dot\"></span><span class=\"dot\"></span><span class=\"dot\"></span>');\n            messagesScroll.append(typing);\n            this.scrollToBottom();\n        }\n\n        hideTypingIndicator() {\n            this.modal.find('.tutor-ia-typing').remove();\n        }\n\n        scrollToBottom() {\n            const messagesScroll = this.modal.find(SELECTORS.MESSAGES_SCROLL);\n            if (messagesScroll.length) {\n                messagesScroll.scrollTop(messagesScroll[0].scrollHeight);\n            }\n        }\n\n        closeCurrentStream() {\n            if (this.currentEventSource) {\n                try {\n                    this.currentEventSource.close();\n                } catch (e) {\n                    window.console.warn('Error closing EventSource:', e);\n                }\n            }\n            this.currentEventSource = null;\n            this.streaming = false;\n            this.hideTypingIndicator();\n        }\n\n        finalizeStream(sendBtn) {\n            this.closeCurrentStream();\n            if (sendBtn) {\n                sendBtn.prop('disabled', false);\n            }\n        }\n\n        sanitizeString(str) {\n            if (typeof str !== 'string') {\n                return '';\n            }\n            return str.replace(/[<>]/g, '');\n        }\n\n        detectPageContext() {\n            const context = {};\n\n            if (typeof M !== 'undefined' && M.cfg && M.cfg.pagetype) {\n                context.pagetype = M.cfg.pagetype;\n            }\n\n            if (!context.pagetype) {\n                const bodyId = document.body.id;\n                if (bodyId) {\n                    context.pagetype = bodyId.replace('page-', '');\n                }\n            }\n\n            return context;\n        }\n\n        cleanup() {\n            this.closeCurrentStream();\n        }\n    }\n\n    return {\n        init: function() {\n            return new AIModal();\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","SELECTORS","AIModal","constructor","modal","streaming","currentEventSource","currentSessionId","conversationStarted","courseId","cmId","userId","init","registerEventListeners","document","on","e","preventDefault","openModal","closeModal","sendMessage","key","shiftKey","style","height","Math","min","this","scrollHeight","prompt","currentTarget","data","handleQuickOption","target","is","stopPropagation","isModalOpen","window","cleanup","length","fadeIn","addClass","setTimeout","find","focus","console","error","closeCurrentStream","fadeOut","removeClass","empty","hide","show","val","css","input","sendBtn","messageText","trim","addMessage","prop","startConversation","scrollToBottom","showTypingIndicator","metaData","user_role","timestamp","floor","Date","now","source","cmid","parseInt","pageContext","detectPageContext","pagetype","page","log","call","methodname","args","courseid","message","sanitizeString","substring","meta","JSON","stringify","then","stream_url","Error","session_id","startSSE","catch","err","hideTypingIndicator","exception","streamUrl","es","EventSource","firstToken","messageCompleted","currentMessageEl","addEventListener","ev","payload","parse","text","t","content","createAIMessage","appendToMessage","warn","finalizeStream","messagesScroll","messageEl","append","currentText","textContent","remaining","type","typing","html","remove","scrollTop","close","str","replace","context","M","cfg","bodyId","body","id"],"mappings":"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"}